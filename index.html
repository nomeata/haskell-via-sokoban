<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Joachim Breitner" />
  <title>Haskell via Sokoban</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="static/pandoc.css" />
  <link rel="stylesheet" href="static/solution.css" />
  <link rel="stylesheet" href="static/inline-code.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script defer="defer">
  function onload(){
    var elements = document.querySelectorAll(".Solution");
    function reveal() { this.classList.add("revealed"); }
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener("click", reveal);
    }
  };
  document.addEventListener( "DOMContentLoaded", onload, false );
  </script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Haskell via Sokoban</h1>
<p class="author"><a href="http://www.joachim-breitner.de/">Joachim Breitner</a></p>
<p class="date">Wednesday, 7 September</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#preface">Preface</a></li>
<li><a href="#prelude"><span class="toc-section-number">1</span> Prelude</a><ul>
<li><a href="#what-is-haskell"><span class="toc-section-number">1.1</span> What is Haskell?</a></li>
<li><a href="#themes"><span class="toc-section-number">1.2</span> Themes</a></li>
<li><a href="#programming-environment"><span class="toc-section-number">1.3</span> Programming environment</a></li>
</ul></li>
<li><a href="#basic-haskell"><span class="toc-section-number">2</span> Basic Haskell</a><ul>
<li><a href="#declarations-and-variables"><span class="toc-section-number">2.1</span> Declarations and variables</a></li>
<li><a href="#picture-types-and-functions"><span class="toc-section-number">2.2</span> Picture Types and Functions</a></li>
<li><a href="#defining-functions"><span class="toc-section-number">2.3</span> Defining functions</a></li>
<li><a href="#animations"><span class="toc-section-number">2.4</span> Animations</a></li>
<li><a href="#numerical-types"><span class="toc-section-number">2.5</span> Numerical Types</a></li>
</ul></li>
<li><a href="#recursion"><span class="toc-section-number">3</span> Recursion</a></li>
<li><a href="#code-comments"><span class="toc-section-number">4</span> Code Comments</a></li>
<li><a href="#a-word-about-error-messages"><span class="toc-section-number">5</span> A word about error messages</a></li>
<li><a href="#exercises"><span class="toc-section-number">6</span> ✍️ Exercises</a><ul>
<li><a href="#traffic-lights"><span class="toc-section-number">6.1</span> Traffic lights</a></li>
<li><a href="#blooming-trees"><span class="toc-section-number">6.2</span> Blooming trees</a></li>
<li><a href="#sokoban-tiles"><span class="toc-section-number">6.3</span> Sokoban tiles</a></li>
</ul></li>
<li><a href="#higher-order-functions"><span class="toc-section-number">7</span> Higher Order Functions</a><ul>
<li><a href="#partial-application"><span class="toc-section-number">7.1</span> Partial application</a></li>
<li><a href="#local-definitions"><span class="toc-section-number">7.2</span> Local definitions</a></li>
<li><a href="#captured-variables"><span class="toc-section-number">7.3</span> Captured variables</a></li>
<li><a href="#a-note-on-indentation"><span class="toc-section-number">7.4</span> A note on indentation</a></li>
<li><a href="#lambda-expressions"><span class="toc-section-number">7.5</span> Lambda expressions</a></li>
</ul></li>
<li><a href="#data-types"><span class="toc-section-number">8</span> Data types</a><ul>
<li><a href="#booleans"><span class="toc-section-number">8.1</span> Booleans</a></li>
<li><a href="#more-data-types-for-sokoban"><span class="toc-section-number">8.2</span> More data types for Sokoban</a></li>
</ul></li>
<li><a href="#pure-interaction"><span class="toc-section-number">9</span> Pure Interaction</a><ul>
<li><a href="#interaction-on-codeworld"><span class="toc-section-number">9.1</span> Interaction on CodeWorld</a></li>
<li><a href="#events"><span class="toc-section-number">9.2</span> Events</a></li>
<li><a href="#some-terminology"><span class="toc-section-number">9.3</span> Some terminology</a></li>
</ul></li>
<li><a href="#exercises-1"><span class="toc-section-number">10</span> ✍️ Exercises</a><ul>
<li><a href="#the-small-guy-or-girl-moves"><span class="toc-section-number">10.1</span> The small guy (or girl) moves</a></li>
<li><a href="#look-the-right-way"><span class="toc-section-number">10.2</span> Look the right way!</a></li>
<li><a href="#reset"><span class="toc-section-number">10.3</span> Reset!</a></li>
<li><a href="#new-level-optional"><span class="toc-section-number">10.4</span> New level (optional)</a></li>
</ul></li>
<li><a href="#polymorphism"><span class="toc-section-number">11</span> Polymorphism</a><ul>
<li><a href="#parametricity"><span class="toc-section-number">11.1</span> Parametricity</a></li>
<li><a href="#polymorphic-data-types"><span class="toc-section-number">11.2</span> Polymorphic Data Types</a></li>
<li><a href="#wholemeal-interactions"><span class="toc-section-number">11.3</span> Wholemeal interactions</a></li>
</ul></li>
<li><a href="#recursive-data-types"><span class="toc-section-number">12</span> Recursive data types</a></li>
<li><a href="#case-expressions"><span class="toc-section-number">13</span> Case expressions</a></li>
<li><a href="#exercises-build-sokoban"><span class="toc-section-number">14</span> ✍️ Exercises: Build Sokoban</a><ul>
<li><a href="#step-1-the-state"><span class="toc-section-number">14.1</span> Step 1: The state</a></li>
<li><a href="#step-2-the-initial-state"><span class="toc-section-number">14.2</span> Step 2: The initial state</a></li>
<li><a href="#step-3-many-mazes"><span class="toc-section-number">14.3</span> Step 3: Many mazes</a></li>
<li><a href="#step-4-draw-the-state"><span class="toc-section-number">14.4</span> Step 4: Draw the state</a></li>
<li><a href="#step-5-handling-event"><span class="toc-section-number">14.5</span> Step 5: Handling event</a></li>
<li><a href="#step-6-putting-it-all-together"><span class="toc-section-number">14.6</span> Step 6: Putting it all together</a></li>
<li><a href="#step-7-winning"><span class="toc-section-number">14.7</span> Step 7: Winning</a></li>
</ul></li>
<li><a href="#type-classes"><span class="toc-section-number">15</span> Type classes</a><ul>
<li><a href="#the-eq-type-class"><span class="toc-section-number">15.1</span> The Eq type class</a></li>
<li><a href="#the-eq-coord-instance"><span class="toc-section-number">15.2</span> The <code>Eq Coord</code> instance</a></li>
<li><a href="#default-implementations"><span class="toc-section-number">15.3</span> Default implementations</a></li>
<li><a href="#the-eq-tile-instance"><span class="toc-section-number">15.4</span> The <code>Eq Tile</code> instance</a></li>
<li><a href="#equality-is-not-for-everyone"><span class="toc-section-number">15.5</span> Equality is not for everyone</a></li>
<li><a href="#benefits-of-type-classes"><span class="toc-section-number">15.6</span> Benefits of type classes</a></li>
<li><a href="#use-case-undo-stacks"><span class="toc-section-number">15.7</span> Use case: Undo stacks</a></li>
<li><a href="#type-classes-vs.-object-oriented-classes"><span class="toc-section-number">15.8</span> Type classes vs. object-oriented classes</a></li>
<li><a href="#other-type-classes-you-should-know-about"><span class="toc-section-number">15.9</span> Other type classes you should know about</a></li>
</ul></li>
<li><a href="#exercises-graph-algorithms"><span class="toc-section-number">16</span> ✍️ Exercises: Graph algorithms</a><ul>
<li><a href="#import-the-list-of-mazes"><span class="toc-section-number">16.1</span> Import the list of mazes</a></li>
<li><a href="#more-polymorphic-list-function"><span class="toc-section-number">16.2</span> More polymorphic list function</a></li>
<li><a href="#graph-search"><span class="toc-section-number">16.3</span> Graph search</a></li>
<li><a href="#check-closedness-of-mazes"><span class="toc-section-number">16.4</span> Check closedness of mazes</a></li>
<li><a href="#multi-level-sokoban"><span class="toc-section-number">16.5</span> Multi-Level Sokoban</a></li>
</ul></li>
</ul>
</nav>
<p><a id="nav-toggle" href="#TOC"></a></p>
<section id="preface" class="level1 unnumbered">
<h1>Preface</h1>
<p>This Haskell tutorial is based on the 2016 installment of the <a href="https://www.cis.upenn.edu/~cis194/fall16/">CIS194 Haskell course at the University of Pennsylvania</a>, and encompasses the first four lectures. What’s interesting about sessions is that they start teaching the very basics of Haskell using the <a href="https://code.world/haskell">CodeWorld</a> online programming environment, so you can get started right away.</p>
<p>I have moved these lectures here partly because the CodeWorld API changes over time, so some of the examples on the CIS194 website stopped working. This only affects lectures 1–4, so if after working through the present document, you can right away start with <a href="https://www.cis.upenn.edu/~cis194/fall16/lectures/05-real-world-haskell.html">lecture 5 (“Real World Haskell”)</a>. But before that, enjoy this introduction.</p>
<p>This material was inspired by and builds on the content of the previous installments for the CIS194 courses, held by Brent Yorgey, Richard Eisenberg and Noam Zilberstein. You can view <a href="https://github.com/nomeata/haskell-via-sokoban/">the source on GitHub</a> of this document, and submit improvements there.</p>
<p>If you happen to be mainly interested in learning to <em>read</em> Haskell, you might be interested in my lecture notes for <a href="http://haskell-for-readers.nomeata.de/">“Haskell for Readers”</a>.</p>
</section>
<section id="prelude" class="level1">
<h1><span class="header-section-number">1</span> Prelude</h1>
<section id="what-is-haskell" class="level2">
<h2><span class="header-section-number">1.1</span> What is Haskell?</h2>
<p>Haskell is a <em>lazy, functional</em> programming language created in the late 1980’s by a committee of academics. There were a plethora of lazy functional languages around, everyone had their favorite, and it was hard to communicate ideas. So a bunch of people got together and designed a new language, taking some of the best ideas from existing languages (and a few new ideas of their own). Haskell was born.</p>
<p>So what is Haskell like? Haskell is:</p>
<section id="functional" class="level3">
<h3><span class="header-section-number">1.1.1</span> Functional</h3>
<figure>
<img src="images/function-machine.png" alt="Function composition" class="floatright" width="200" /><figcaption>Function composition</figcaption>
</figure>
<p>There is no precise, accepted meaning for the term “functional”. But when we say that Haskell is a <em>functional</em> language, we usually have in mind two things:</p>
<ul>
<li><p>Functions are <em>first-class</em>, that is, functions are values which can be used in exactly the same ways as any other sort of value.</p></li>
<li><p>The meaning of Haskell programs is centered around <em>evaluating expressions</em> rather than <em>executing instructions</em>.</p></li>
</ul>
<p>Taken together, these result in an entirely different way of thinking about programming. Much of our time this semester will be spent exploring this way of thinking.</p>
</section>
<section id="pure" class="level3">
<h3><span class="header-section-number">1.1.2</span> Pure</h3>
<figure>
<img src="images/pure.jpg" alt="Not this kind of purity" class="floatright" width="200" /><figcaption>Not this kind of purity</figcaption>
</figure>
<p>Haskell expressions are always <em>referentially transparent</em>, that is:</p>
<ul>
<li><p>No mutation! Everything (variables, data structures…) is <em>immutable</em>.</p></li>
<li><p>Expressions never have “side effects” (like updating global variables or printing to the screen).</p></li>
<li><p>Calling the same function with the same arguments results in the same output every time. Programs are <em>deterministic</em>.</p></li>
</ul>
<p>This may sound crazy at this point. How is it even possible to get anything done without mutation or side effects? Well, it certainly requires a shift in thinking (if you’re used to an imperative or object-oriented paradigm). But once you’ve made the shift, there are a number of wonderful benefits:</p>
<ul>
<li><p><em>Equational reasoning and refactoring</em>: In Haskell one can always “replace equals by equals”, just like you learned in algebra class.</p></li>
<li><p><em>Parallelism</em>: Evaluating expressions in parallel is easy when they are guaranteed not to affect one another.</p></li>
<li><p><em>Fewer headaches</em>: Simply put, unrestricted effects and action-at-a-distance makes for programs that are hard to debug, maintain, and reason about.</p></li>
</ul>
</section>
<section id="lazy" class="level3">
<h3><span class="header-section-number">1.1.3</span> Lazy</h3>
<figure>
<img src="images/relax.jpg" alt="Not this kind of laziness" class="floatright" width="200" /><figcaption>Not this kind of laziness</figcaption>
</figure>
<p>In Haskell, expressions are <em>not evaluated until their results are actually needed</em>. This is a simple decision with far-reaching consequences, which we will explore throughout the semester. Some of the consequences include:</p>
<ul>
<li><p>It is easy to define a new <em>control structure</em> just by defining a function.</p></li>
<li><p>It is possible to define and work with <em>infinite data structures</em>.</p></li>
<li><p>It enables a more compositional programming style (see <em>wholemeal programming</em> below).</p></li>
<li><p>One major downside, however, is that reasoning about time and space usage becomes much more complicated!</p></li>
</ul>
</section>
<section id="statically-typed" class="level3">
<h3><span class="header-section-number">1.1.4</span> Statically typed</h3>
<figure>
<img src="images/static.jpg" alt="Not this kind of static" class="floatright" width="200" /><figcaption>Not this kind of static</figcaption>
</figure>
<p>Every Haskell expression has a type, and types are all checked at <em>compile-time</em>. Programs with type errors will not even compile, much less run.</p>
</section>
</section>
<section id="themes" class="level2">
<h2><span class="header-section-number">1.2</span> Themes</h2>
<p>Throughout this course, we will focus on three main themes.</p>
<section id="types" class="level3">
<h3><span class="header-section-number">1.2.1</span> Types</h3>
<p>Static type systems can seem annoying. In fact, in languages like C++ and Java, they <em>are</em> annoying. But this isn’t because static type systems <em>per se</em> are annoying; it’s because C++ and Java’s type systems are insufficiently expressive! This semester we’ll take a close look at Haskell’s type system, which</p>
<ul>
<li><p><em>Helps clarify thinking and express program structure</em></p>
<p>The first step in writing a Haskell program is usually to <em>write down all the types</em>. Because Haskell’s type system is so expressive, this is a non-trivial design step and is an immense help in clarifying one’s thinking about the program.</p></li>
<li><p><em>Serves as a form of documentation</em></p>
<p>Given an expressive type system, just looking at a function’s type tells you a lot about what the function might do and how it can be used, even before you have read a single word of written documentation.</p>
<p>And it goes the other way: If you are using existing code, such as a library, and you are searching for a specific functionality, you often anticipate the type of the function you need, and you can find it based on that.</p></li>
<li><p><em>Turns run-time errors into compile-time errors</em></p>
<p>It’s much better to be able to fix errors up front than to just test a lot and hope for the best. “If it compiles, it must be correct” is mostly facetious (it’s still quite possible to have errors in logic even in a type-correct program), but you are much more likely to have this experience in Haskell than in other languages.</p></li>
</ul>
</section>
<section id="abstraction" class="level3">
<h3><span class="header-section-number">1.2.2</span> Abstraction</h3>
<p>“Don’t Repeat Yourself” is a mantra often heard in the world of programming. Also known as the “Abstraction Principle”, the idea is that nothing should be duplicated: every idea, algorithm, and piece of data should occur exactly once in your code. Taking similar pieces of code and factoring out their commonality is known as the process of <em>abstraction</em>.</p>
<p>Haskell is very good at abstraction: features like parametric polymorphism, higher-order functions, and type classes all aid in the fight against repetition. Our journey through Haskell this semester will in large part be a journey from the specific to the abstract.</p>
</section>
<section id="wholemeal-programming" class="level3">
<h3><span class="header-section-number">1.2.3</span> Wholemeal programming</h3>
<p>Another theme we will explore is <em>wholemeal programming</em>. A quote from Ralf Hinze:</p>
<blockquote>
<p>“Functional languages excel at wholemeal programming, a term coined by Geraint Jones. Wholemeal programming means to think big: work with an entire list, rather than a sequence of elements; develop a solution space, rather than an individual solution; imagine a graph, rather than a single path. The wholemeal approach often offers new insights or provides new perspectives on a given problem. It is nicely complemented by the idea of projective programming: first solve a more general problem, then extract the interesting bits and pieces by transforming the general program into more specialised ones.”</p>
</blockquote>
<p>For example, consider this pseudocode in a C/Java-ish sort of language:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" title="1"><span class="dt">int</span> acc = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="cf">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; lst.length; i++ ) {</a>
<a class="sourceLine" id="cb1-3" title="3">  acc = acc + <span class="dv">3</span> * lst[i];</a>
<a class="sourceLine" id="cb1-4" title="4">}</a></code></pre></div>
<p>This code suffers from what Richard Bird refers to as “indexitis”: it has to worry about the low-level details of iterating over an array by keeping track of a current index. It also mixes together what can more usefully be thought of as two separate operations: multiplying every item in a list by 3, and summing the results.</p>
<p>In Haskell, we can just write</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">sum</span> (<span class="fu">map</span> (<span class="dv">3</span><span class="fu">*</span>) lst)</a></code></pre></div>
<p>This semester we’ll explore the shift in thinking represented by this way of programming, and examine how and why Haskell makes it possible.</p>
</section>
</section>
<section id="programming-environment" class="level2">
<h2><span class="header-section-number">1.3</span> Programming environment</h2>
<p>In this class, we start working within a programming environment called CodeWorld, which you can access at <a href="http://code.world/haskell" class="uri">http://code.world/haskell</a> (the <code>/haskell</code> is important). This has the advantages that</p>
<ul>
<li>we can start straight away, and take care of local installation later</li>
<li>with the integrated support for displaying graphical output, we can have nice, visual, examples and initial tasks.</li>
</ul>
<p>We will switch to compiling programs locally later during the course. If you want to work locally from the start, there are instructions on the course website.</p>
</section>
</section>
<section id="basic-haskell" class="level1">
<h1><span class="header-section-number">2</span> Basic Haskell</h1>
<p>So let us see some Haskell code. On CodeWorld, we generally start with this code (<a href="https://code.world/haskell#PvoZv8n9Mtp5kOMGDszKEcQ">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">import</span> <span class="dt">CodeWorld</span></a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="ot">ourPicture ::</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb3-5" title="5">ourPicture <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-8" title="8">main <span class="fu">=</span> drawingOf ourPicture</a></code></pre></div>
<p>Most of these lines are not interesting initially, and will be understood fully later on. If we run this, using the green “Run” button, or alternatively pressing <em>Ctrl-Enter</em>, we see … nothing.</p>
<section id="declarations-and-variables" class="level2">
<h2><span class="header-section-number">2.1</span> Declarations and variables</h2>
<p>Not very surprising, since our picture is <code>blank</code>. So let us change this line to something that we can see:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1">ourPicture <span class="fu">=</span> solidCircle <span class="dv">1</span></a></code></pre></div>
<p>We now see a solid black circle of radius 1:</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=Dr1Q5xP3mnSKnUkmVvq9_qQ">
</iframe>
<p>What happens here? This code declares a variable with name <code>ourPicture</code> with type <code>Picture</code> (“<code>::</code>” is pronounced “has type”), and defines its value to be <code>circle 1</code>.</p>
<p>Note that <em>this will be the value of <code>ourPicture</code> forever</em> (at least, in this particular program). The value of <code>ourPicture</code> cannot be changed later.</p>
<p>If we would try to write something like</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1">ourPicture <span class="fu">=</span> solidCircle <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-2" title="2">ourPicture <span class="fu">=</span> solidCircle <span class="dv">2</span></a></code></pre></div>
<p>then we get an error message complaining about <code>Multiple declarations of ‘ourPicture’</code>.</p>
<p>In Haskell, <em>variables are not mutable boxes</em>; they are just names for values!</p>
<p>Put another way, <code>=</code> does <em>not</em> denote “assignment” like it does in many other languages. Instead, <code>=</code> denotes <em>definition</em>, like it does in mathematics. That is, <code>ourPicture = solidCircle 1</code> should not be read as “<code>ourPicture</code> gets <code>solidCircle 1</code>” or “assign <code>solidCircle 1</code> to <code>ourPicture</code>”, but as “<code>ourPicture</code> is <em>defined to be</em> <code>solidCircle 1</code>”.</p>
<p>What do you think this code means?</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="ot">y ::</span> <span class="dt">Integer</span></a>
<a class="sourceLine" id="cb6-2" title="2">y <span class="fu">=</span> y <span class="fu">+</span> <span class="dv">1</span></a></code></pre></div>
</section>
<section id="picture-types-and-functions" class="level2">
<h2><span class="header-section-number">2.2</span> Picture Types and Functions</h2>
<p>In contrast to a classical intro into Haskell, we do not start with numbers, booleans, tuples, lists and strings, but we start with pictures. These are of course library-defined (hence the <code>import CodeWorld</code>) and not part of “the language”. But that does not make them less interesting, and in fact, even the basic boolean type is library defined – it just happens to be the standard library.</p>
<section id="primitive-pictures" class="level3">
<h3><span class="header-section-number">2.2.1</span> Primitive pictures</h3>
<p>Every picture is a value of type, well, <code>Picture</code>. We have seen two such values so far: <code>blank</code> and <code>solidCircle 1</code>. There are many more primitive pictures, for rectangles, polygons, lines, arcs and text. To get an overview, see the Help button on CodeWorld: From there you can reach the documentation of the <code>CodeWorld</code> API.</p>
<p>If we look at the documentation for <code>solidCircle</code>, it says</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="ot">solidCircle ::</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>The arrow (<code>-&gt;</code>) indicates that <code>solidCircle</code> itself is a <em>function</em>, turning a value of type <code>Double</code> – i.e. a floating point number – into a picture. Now <code>1</code> happens to be a real number, therefore <code>solidCircle 1</code> is a <code>Picture</code>.</p>
<p>You can see that function application in Haskell works without parentheses, you just write the argument after the function. But if the argument itself is more complex than just one number of variable name, you have to put parentheses around it:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1">ourPicture <span class="fu">=</span> solidCircle (<span class="dv">1</span><span class="fu">+</span><span class="dv">1</span>)</a></code></pre></div>
<p><!-- maybe not yet here

Another interesting function is `lettering`, which turns text into a picture:

> ourPicture = lettering "Hello World"

If you forget the line `{-# LANGUAGE OverloadedStrings #-}` you will get this
error message when working with text:

    Couldn't match expected type ‘Data.Text.Internal.Text’
                with actual type ‘[Char]’
    In the first argument of ‘lettering’, namely ‘"Hello World"’
    In the expression: lettering "Hello World"
    In an equation for ‘ourPicture’: ourPicture = lettering "Hello World"
--></p>
</section>
<section id="modifying-pictures" class="level3">
<h3><span class="header-section-number">2.2.2</span> Modifying Pictures</h3>
<p>Let us bring some color into the picture. In the documentation, we see this function</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="ot">colored ::</span> <span class="dt">Color</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>There are two arrows! What do we make of that? This means that <code>colored</code> is a function expecting two arguments, namely a color and a picture, and then returns a – presumably colored – picture. There are many colors defined, so we can write</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1">ourPicture <span class="fu">=</span> colored green (solidCircle <span class="dv">1</span>)</a></code></pre></div>
<p>As you see, even multiple arguments are just written after the function, separated by a space, and complex arguments need to be enclosed in parentheses.</p>
<p>So what is the deal with two two arrows? Why not just <code>Color Picture -&gt; Picture</code>? It might seem strange to you now, but there is a very deep and beautiful reason, to which we will get in a few weeks; for now you just have to take my word for it!</p>
</section>
<section id="composing-pictures" class="level3">
<h3><span class="header-section-number">2.2.3</span> Composing Pictures</h3>
<p>By now we are tired of seeing single circles. We want more! So we need a way to draw more than one thing. So what we are looking for is a function that takes two pictures, and combines them to one. You should agree with me that such a function likely would have type <code>Picture -&gt; Picture -&gt; Picture</code>.</p>
<p>And now we are experiencing one of the advantages of a good type system: We can search for a type! Indeed, there is only one function in the documentation that has this type</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">(&amp;) ::</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>That is a strange name for a function, but it is indeed one name for it, and we could use <code>(&amp;)</code> as a normal function, putting the arguments to its right. But, as you might have guessed, we can use <code>&amp;</code> (without the parentheses) as an operator, and put it in between two pictures.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1">ourPicture <span class="fu">=</span> colored green (solidCircle <span class="dv">1</span>) <span class="fu">&amp;</span> solidCircle <span class="dv">2</span></a></code></pre></div>
<p>From the resulting picture we can learn a few things</p>
<ul>
<li>The <code>&amp;</code> operator combines two pictures, but puts them in the same spot, with the picture given as the left argument on top of the picture given as the right argument.</li>
<li><p>The function <code>colored green</code> applied only to <code>(solidCircle 1)</code>, and <em>not</em> to <code>(solidCircle 1) &amp; solidCircle 2</code> (otherwise, both circles would be green). From this we deduce an important fact about Haskell syntax that you should remember well:</p>
<p><em>Function application binds tighter than any binary operators.</em></p></li>
</ul>
<p>In order to create nicer pictures, we need to be able to place our pictures somewhere else than just the middle. For this, we use the function</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1"><span class="ot">translated ::</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>which shoves a picture around. So here we go:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1">ourPicture <span class="fu">=</span> colored green (translated <span class="dv">0</span> (<span class="fu">-</span><span class="fl">1.5</span>) (solidCircle <span class="dv">1</span>)) <span class="fu">&amp;</span> colored red (translated <span class="dv">0</span> (<span class="fl">1.5</span>) (solidCircle <span class="dv">1</span>))</a></code></pre></div>
<p>Now we are getting somewhere. The parentheses around <code>-1.5</code> are necessary as otherwise the compiler would think we want to use the binary subtraction operator.</p>
<p>Our code line got too long, so let us name some of the components and give them their own names, and while we are at it, draw a frame around our traffic light (<a href="https://code.world/haskell#PghsHgwl_rJUmdcCvOPAR_w">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1">botCircleGreen <span class="fu">=</span> colored green (translated <span class="dv">0</span> (<span class="fu">-</span><span class="fl">1.5</span>) (solidCircle <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb15-2" title="2">topCircleRed   <span class="fu">=</span> colored red   (translated <span class="dv">0</span>   <span class="fl">1.5</span>  (solidCircle <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb15-3" title="3">frame <span class="fu">=</span> rectangle <span class="fl">2.5</span> <span class="fl">5.5</span></a>
<a class="sourceLine" id="cb15-4" title="4">trafficLight <span class="fu">=</span> botCircleGreen <span class="fu">&amp;</span> topCircleRed <span class="fu">&amp;</span> frame</a>
<a class="sourceLine" id="cb15-5" title="5"></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="ot">ourPicture ::</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb15-7" title="7">ourPicture <span class="fu">=</span> trafficLight</a></code></pre></div>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DIGh_cV3nB5b30aG9qopJ2Q">
</iframe>
</section>
</section>
<section id="defining-functions" class="level2">
<h2><span class="header-section-number">2.3</span> Defining functions</h2>
<p>We have seen how to use functions, but we also want define our own. And in a way, we have been defining functions all the time when we wrote <code>something = this and that</code>; this defined a function <code>something</code>, which just happened to not take any argument. If we want it to take any arguments, we just write give their names on the left:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1">botCircle c <span class="fu">=</span> colored c (translated <span class="dv">0</span> (<span class="fu">-</span><span class="fl">1.5</span>) (solidCircle <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb16-2" title="2">topCircle c <span class="fu">=</span> colored c (translated <span class="dv">0</span>   <span class="fl">1.5</span>  (solidCircle <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb16-3" title="3">frame <span class="fu">=</span> rectangle <span class="fl">2.5</span> <span class="fl">5.5</span></a>
<a class="sourceLine" id="cb16-4" title="4">trafficLight <span class="fu">=</span> botCircle green <span class="fu">&amp;</span> topCircle red <span class="fu">&amp;</span> frame</a>
<a class="sourceLine" id="cb16-5" title="5"></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="ot">ourPicture ::</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb16-7" title="7">ourPicture <span class="fu">=</span> trafficLight</a></code></pre></div>
<p>A normal traffic light never shows red and green at the same time. So let us turn <code>trafficLight</code> into a function that shows either a green or a red light. So the argument is going to be a boolean value of type <code>Bool</code>, which can be either <code>True</code> or <code>False</code>. And as a matter of fact, we can write define <code>trafficLight</code> by handling these two cases:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1">trafficLight <span class="dt">True</span>  <span class="fu">=</span> botCircle green <span class="fu">&amp;</span> topCircle black <span class="fu">&amp;</span> frame</a>
<a class="sourceLine" id="cb17-2" title="2">trafficLight <span class="dt">False</span> <span class="fu">=</span> botCircle black <span class="fu">&amp;</span> topCircle red   <span class="fu">&amp;</span> frame</a>
<a class="sourceLine" id="cb17-3" title="3">ourPicture <span class="fu">=</span> trafficLight <span class="dt">True</span></a></code></pre></div>
<p>We could, and we should, also write down the type of <code>trafficLight</code>. Not that the compiler needs us to do that – it is smart enough to figure that out by itself. But it helps us to understand the code better, to confirm that what we wrote is actually what we intended, and to narrow down bugs in the code. Conveniently, the compiler tells us about the correct signature, so we can just copy that:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="ot">trafficLight ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>Here we have applied a very important method in programming in general, and one that is even more powerful in functional programming (for reasons you will learn to appreciate later): We <strong>abstracted</strong> our code, by making the <code>topCircle</code> function <em>abstract</em> in the color, and the <code>trafficLight</code> function <em>abstract</em> in the state it is in.</p>
</section>
<section id="animations" class="level2">
<h2><span class="header-section-number">2.4</span> Animations</h2>
<p>Now the traffic light is green, but we want it to switch to red every now and then. The CodeWorld API not only allows us to draw drawings, but also to run animations. What is an animation? It is a picture that changes over time, where time can conveniently be understood as the number of seconds since the start of the animation.</p>
<p>In imperative language, one would probably have a <code>getCurrentTime()</code> function and call that from somewhere in our drawing generating. This is not possible nor desirable in a pure functional language, as it would be a <em>hidden side effect</em>. Instead, the time is provided as a parameter.</p>
<p>So here this codes makes the traffic light switch every three seconds:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1"><span class="ot">trafficController ::</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb19-2" title="2">trafficController t</a>
<a class="sourceLine" id="cb19-3" title="3">  <span class="fu">|</span> <span class="fu">round</span> (t<span class="fu">/</span><span class="dv">3</span>) <span class="ot">`mod`</span> <span class="dv">2</span> <span class="fu">==</span> <span class="dv">0</span> <span class="fu">=</span> trafficLight <span class="dt">True</span></a>
<a class="sourceLine" id="cb19-4" title="4">  <span class="fu">|</span> <span class="fu">otherwise</span>                <span class="fu">=</span> trafficLight <span class="dt">False</span></a>
<a class="sourceLine" id="cb19-5" title="5"></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb19-7" title="7">main <span class="fu">=</span> animationOf trafficController</a></code></pre></div>
<p>From looking at the code (<a href="https://code.world/haskell#Ph3vruxsOVmcnYG0D2NGG0Q">open on CodeWorld</a>) we notice</p>
<ul>
<li>Instead of <code>drawingOf</code> we use <code>animationOf</code> in the main entry point of the program. Its parameter is no longer simply a value of type <code>Picture</code>, but rather a <em>function</em> of type <code>Double -&gt; Picture</code>. This function will be given the current time, and return the picture for that time.</li>
<li>We again define a function by multiple cases, but this time using a <em>guard</em> to select the case. When called, the conditions of the guards are tried in that order until one evaluates to <code>True</code>. Then this code is taken.</li>
<li><code>otherwise</code> happens to be a defined to be <code>True</code>. It just reads better than writing <code>True</code> here.</li>
<li>There is a function called <code>round</code> and <code>mod</code>. <code>round</code> is used in the normal, prefix way, but we turned <code>mod</code> into an operator by putting backticks around it (<code>`mod`</code>). You can do that two any function called with two arguments.</li>
<li>We are now working with numbers here, so let us take a quick detour into Haskell’s numeric types.</li>
</ul>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DJbj5ZRKwBcCg0cW7Xxs4SA">
</iframe>
</section>
<section id="numerical-types" class="level2">
<h2><span class="header-section-number">2.5</span> Numerical Types</h2>
<p>There are three number-related types we should know about for now: <code>Int</code>, <code>Integer</code> and <code>Double</code>.</p>
<ul>
<li><p><code>Int</code> are machine-sized integers.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1"><span class="ot">i ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb20-2" title="2">i <span class="fu">=</span> <span class="fu">-</span><span class="dv">42</span></a></code></pre></div>
<p><code>Int</code>s are guaranteed by the Haskell language standard to accommodate values at least up to \(\pm 2^{29}\), but the exact size depends on your architecture. For example, on my 64-bit machine the range is \(\pm 2^{63}\).</p></li>
<li><p>The <code>Integer</code> type, on the other hand, is limited only by the amount of memory on your machine.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1"><span class="ot">n ::</span> <span class="dt">Integer</span></a>
<a class="sourceLine" id="cb21-2" title="2">n <span class="fu">=</span> <span class="dv">1234567890987654321987340982334987349872349874534</span></a>
<a class="sourceLine" id="cb21-3" title="3"></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="ot">reallyBig ::</span> <span class="dt">Integer</span></a>
<a class="sourceLine" id="cb21-5" title="5">reallyBig <span class="fu">=</span> <span class="dv">2</span><span class="fu">^</span>(<span class="dv">2</span><span class="fu">^</span>(<span class="dv">2</span><span class="fu">^</span>(<span class="dv">2</span><span class="fu">^</span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb21-6" title="6"></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="ot">numDigits ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb21-8" title="8">numDigits <span class="fu">=</span> <span class="fu">length</span> (<span class="fu">show</span> reallyBig)</a></code></pre></div>
<p>In the code above, <code>numDigits</code> is <code>19729</code>, so the integer type has no problems handling numbers with thousands of digits.</p></li>
<li><p>For (double-precision) floating-point numbers, there is <code>Double</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1">d1,<span class="ot"> d2 ::</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb22-2" title="2">d1 <span class="fu">=</span> <span class="fl">4.5387</span></a>
<a class="sourceLine" id="cb22-3" title="3">d2 <span class="fu">=</span> <span class="fl">6.2831e-4</span></a></code></pre></div>
<p>There is also a single-precision floating point number type, <code>Float</code>, in case you wonder.</p></li>
</ul>
<p>Together with these functions, there are a bunch of operations, as you would expect:</p>
<ul>
<li><p><code>(+)</code>, <code>(-)</code> and <code>(*)</code> work for all numerical types.</p>
<p>(If you see <code>Num a =&gt;</code> in front of a type in the documentation or in the output of <a href="http://tryhaskell.org/" class="uri">http://tryhaskell.org/</a> or your local interpreter session, just read that as “<code>a</code> is one of the numerical types” for now).</p></li>
<li><p><code>(/)</code> only works for <code>Double</code></p></li>
<li><p>For integer division, there is <code>div</code> and <code>mod</code>.</p></li>
<li><p>The usual functions like <code>sin</code>, <code>cos</code>, <code>log</code>, <code>sqrt</code> etc. all exist.</p></li>
</ul>
<p>You cannot mix different types in the same operation, e.g. you cannot directly add <code>d1 + i</code>. If you want to do that, you have to explicitly convert</p>
<ul>
<li><p><code>fromIntegral</code>: converts from any integral type (<code>Int</code> or <code>Integer</code>) to any other numeric type.</p></li>
<li><p><code>round</code>, <code>floor</code>, <code>ceiling</code>: convert floating-point numbers to <code>Int</code> or <code>Integer</code>.</p></li>
</ul>
<p>If you are used to other languages which do implicit conversion of numeric types, this can all seem rather prudish and annoying at first. However, I promise you’ll get used to it – and in time you may even come to appreciate it. Implicit numeric conversion encourages sloppy thinking about numeric code.</p>
<p>In the code above, we also used <code>(==)</code>. This compares two values of the same type for equality. It does work on most types (more on that later). It even works on floating point numbers, but really, it should not be used there (why? see <a href="http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">this article</a>). The test for inequality is <code>(/=)</code>.</p>
<p>There is also <code>(&lt;)</code>, <code>(&gt;)</code>, <code>(&lt;=)</code>, <code>(&gt;=)</code> for comparisons and <code>min</code> and <code>max</code> to take the minimum or maximum of two values.</p>
</section>
</section>
<section id="recursion" class="level1">
<h1><span class="header-section-number">3</span> Recursion</h1>
<p>The last topic for today is recursion. Recursion is when a function calls itself again. Or, more general, if multiple functions call each other.</p>
<p>Recursion is, like abstraction, a very powerful method in functional programming and once you are done with this course, thinking about recursion is going to be the most natural thing in the world.</p>
<p>So lets say we want to put multiple traffic lights next to each other. We could do it this way (<a href="https://code.world/haskell#PNApyEJW7C_zshSxdde3eIw">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1"><span class="ot">lights ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb23-2" title="2">lights <span class="dv">0</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb23-3" title="3">lights n <span class="fu">=</span> trafficLight <span class="dt">True</span> <span class="fu">&amp;</span> translated <span class="dv">3</span> <span class="dv">0</span> (lights (n<span class="fu">-</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5">ourPicture <span class="fu">=</span> lights <span class="dv">3</span></a>
<a class="sourceLine" id="cb23-6" title="6"></a>
<a class="sourceLine" id="cb23-7" title="7">main <span class="fu">=</span> drawingOf ourPicture</a></code></pre></div>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DpUYW1wqSUHZZ4I8Zr_gG5Q">
</iframe>
<p>The function <code>lights</code> is again defined over multiple cases, by pattern-matching on the number of lights to draw. If we should draw no light, we do not draw anything. Otherwise, we draw one light, and the remaining lights shifted to the right.</p>
<p>This is a typical form of recursion: We have a base case, which does not itself use the recursive function any more, and we have the recursive cases, which do.</p>
<p>What happens if I try to draw <code>lights (-1)</code>? What if I swap the arguments to <code>(&amp;)</code>?</p>
<p>Of course, there is a lot of logic involved in <code>lights</code> that that is not specific to traffic lights, so this does call out for some abstraction. We will abstract out both the picture to draw, and how far we shift to the right in every step (<a href="https://code.world/haskell#Pb3XJ3yim9fyIbLeIoaLMDw">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1"><span class="ot">spread ::</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb24-2" title="2">spread pic dx <span class="dv">0</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb24-3" title="3">spread pic dx n <span class="fu">=</span> pic <span class="fu">&amp;</span> translated dx <span class="dv">0</span> (spread pic dx (n<span class="fu">-</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb24-4" title="4"></a>
<a class="sourceLine" id="cb24-5" title="5">ourPicture <span class="fu">=</span> spread (trafficLight <span class="dt">True</span>) <span class="dv">3</span> <span class="dv">4</span></a></code></pre></div>
<p>Side remark: With this code, the compiler warns about unused variables <code>pic</code> and <code>dx</code>. This is a helpful warning, as more often than not if you do not use a value that you named, then that is a bug. If it is not, like in this case, replace the binding by <code>_</code>, indicating that you do not want to name this parameter.</p>
<p>A recursive function may call itself more than once, and this allows for nice drawings (<a href="https://code.world/haskell#P6iOESxXsM38h28u8d0dGwQ">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" title="1"><span class="ot">tree ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb25-2" title="2">tree <span class="dv">0</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb25-3" title="3">tree n <span class="fu">=</span> polyline [(<span class="dv">0</span>,<span class="dv">0</span>),(<span class="dv">0</span>,<span class="dv">1</span>)] <span class="fu">&amp;</span> translated <span class="dv">0</span> <span class="dv">1</span> (</a>
<a class="sourceLine" id="cb25-4" title="4">    rotated (<span class="fu">pi/</span><span class="dv">10</span>) (tree (n<span class="fu">-</span><span class="dv">1</span>)) <span class="fu">&amp;</span> rotated (<span class="fu">-</span> <span class="fu">pi/</span><span class="dv">10</span>) (tree (n<span class="fu">-</span><span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb25-5" title="5"></a>
<a class="sourceLine" id="cb25-6" title="6">main <span class="fu">=</span> drawingOf (tree <span class="dv">8</span>)</a></code></pre></div>
<p>We will get to the meaning of the lists with brackets and the pairs with parentheses next lesson, for now just consider this a way of drawing a line from one point to another.</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=D0I8_Q8vsd_SaZecztt7QxA">
</iframe>
<p>(Do you want to see the tree folding and unfolding? Requires only minor changes to the code… check out <a href="https://code.world/haskell#PtY2_l_npAAiqP2cZKKFgpQ">this animation</a>.)</p>
</section>
<section id="code-comments" class="level1">
<h1><span class="header-section-number">4</span> Code Comments</h1>
<p>Not very exciting, but good to know: You can have comments in Haskell code in one of two formats:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1"><span class="co">-- Two hyphens, until the end of the line</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="co">{- or enclosed</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="co">   in curly brace/hyphen pairs, which may span multiple lines</span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="co"> -}</span></a></code></pre></div>
</section>
<section id="a-word-about-error-messages" class="level1">
<h1><span class="header-section-number">5</span> A word about error messages</h1>
<p>Actually, six:</p>
<p><strong>Don’t be scared of error messages!</strong></p>
<p>GHC’s error messages can be rather long and (seemingly) scary. However, usually they’re long not because they are obscure, but because they contain a lot of useful information! Here’s an example:</p>
<pre><code>Prelude&gt; &#39;x&#39; ++ &quot;foo&quot;

&lt;interactive&gt;:1:1:
    Couldn&#39;t match expected type `[a0]&#39; with actual type `Char&#39;
    In the first argument of `(++)&#39;, namely &#39;x&#39;
    In the expression: &#39;x&#39; ++ &quot;foo&quot;
    In an equation for `it&#39;: it = &#39;x&#39; ++ &quot;foo&quot;</code></pre>
<p>First we are told “Couldn’t match expected type <code>[a0]</code> with actual type <code>Char</code>”. This means that <em>something</em> was expected to have a list type, but actually had type <code>Char</code>. What something? The next line tells us: it’s the first argument of <code>(++)</code> which is at fault, namely, <code>'x'</code>. The next lines go on to give us a bit more context. Now we can see what the problem is: clearly <code>'x'</code> has type <code>Char</code>, as the first line said. Why would it be expected to have a list type? Well, because it is used as an argument to <code>(++)</code>, which takes a list as its first argument.</p>
<p>When you get a huge error message, resist your initial impulse to run away; take a deep breath; and read it carefully. You won’t necessarily understand the entire thing, but you will probably learn a lot, and you may just get enough information to figure out what the problem is.</p>
</section>
<section id="exercises" class="level1 exercises">
<h1><span class="header-section-number">6</span> ✍️ Exercises</h1>
<p>When solving the exercises, strive to create not just code that works, but code that is stylish and concise. Try to write small functions which perform just a single task, and then combine those smaller pieces to create more complex functions. Don’t repeat yourself: write one function for each logical task, and reuse functions as necessary.</p>
<p>In these exercises, you will be creating lots of drawing and animations. The exercises will describe what you have to do, and maybe give an (simple) example, but you are always welcome to make it prettier and more shiny. This is all good as long as you do not <em>simplify</em> the task this way, or make the code too convoluted. Extra effort in that direction contributes towards your participation score.</p>
<p>All homework this week can be performed within the web IDE <a href="https://code.world/haskell" class="uri">https://code.world/haskell</a>.</p>
<section id="traffic-lights" class="level2">
<h2><span class="header-section-number">6.1</span> Traffic lights</h2>
<p>In the class, we defined a traffic light animation. Real traffic lights have an amber light in the middle.</p>
<p>Change the code to include the yellow light, and animate a correct sequence of traffic light signaling:</p>
<ul>
<li>a long green phase</li>
<li>a short amber phase</li>
<li>a long red phase</li>
<li>a short red and amber phase<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></li>
<li>back to green</li>
</ul>
<p>Yon can start with <a href="https://code.world/haskell#Ph3vruxsOVmcnYG0D2NGG0Q">the traffic light code from above</a>, and the result could look like this:</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DqZGdJ4_KXlDS_N6rS017Ow">
</iframe>
</section>
<section id="blooming-trees" class="level2">
<h2><span class="header-section-number">6.2</span> Blooming trees</h2>
<p>In the class, we defined a tree, but it looks a bit dire. Here is <a href="https://code.world/haskell#P6iOESxXsM38h28u8d0dGwQ">the code again</a>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" title="1"><span class="ot">tree ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb28-2" title="2">tree <span class="dv">0</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb28-3" title="3">tree n <span class="fu">=</span> polyline [(<span class="dv">0</span>,<span class="dv">0</span>),(<span class="dv">0</span>,<span class="dv">1</span>)] <span class="fu">&amp;</span> translated <span class="dv">0</span> <span class="dv">1</span> (</a>
<a class="sourceLine" id="cb28-4" title="4">  rotated (<span class="fu">pi/</span><span class="dv">10</span>) (tree (n<span class="fu">-</span><span class="dv">1</span>)) <span class="fu">&amp;</span> rotated (<span class="fu">-</span> <span class="fu">pi/</span><span class="dv">10</span>) (tree (n<span class="fu">-</span><span class="dv">1</span>)))</a></code></pre></div>
<p>Make the tree bloom! Create an animation that looks like the dire <code>tree 8</code> initially, and then grows blossoms at the end of each twig within 10 seconds. After 10 seconds, the tree should be in full bloom and the animation should stop.</p>
<p>A bloom could be a yellow circle growing in size, or something more intricate with petals and better colors and whatnot.</p>
<p>In your code, modify <code>tree</code> to be <em>abstract</em> in the actual shape of the blossoms. This way, the <code>tree</code> function itself is independent of time. Do <em>not</em> pass the time parameter to the <code>tree</code> function!</p>
<p>The result could look like this:</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DTWphwOKI8RGp6RvZ_FELbA">
</iframe>
</section>
<section id="sokoban-tiles" class="level2">
<h2><span class="header-section-number">6.3</span> Sokoban tiles</h2>
<p>Until the end of the tutorial, you will implement a game of Sokoban. The rules are simple (quoted from <a href="https://en.wikipedia.org/wiki/Sokoban" class="uri">https://en.wikipedia.org/wiki/Sokoban</a>, which also contains a nice animation that you can look at):</p>
<blockquote>
<p>The game is played on a board of squares, where each square is a floor or a wall. Some floor squares contain boxes, and some floor squares are marked as storage locations.</p>
<p>The player is confined to the board, and may move horizontally or vertically onto empty squares (never through walls or boxes). The player can also move into a box, which pushes it into the square beyond. Boxes may not be pushed into other boxes or walls, and they cannot be pulled. The puzzle is solved when all boxes are at storage locations.</p>
</blockquote>
<p>We do some preparations this week. In particular, we need the different squares that may occur:</p>
<ol type="1">
<li><p>Walls</p></li>
<li><p>Ground, i.e. empty spaces</p></li>
<li><p>Ground marked as storage</p></li>
<li><p>Boxes</p></li>
</ol>
<p>After this exercise, we will have the necessary code to draw a sokoban level. You can use <a href="https://code.world/haskell#PhaxQVa5_9uWXva_quQwPcA">this code</a> to get started.</p>
<ul>
<li><p>Create a functions <code>wall</code>, <code>ground</code>, <code>storage</code> and <code>box</code> of type <code>Picture</code>, which draw the corresponding thing, with a width and height of 1 and positioned at the center of the picture.</p>
<p>The example picture below is very much on the dull side. Make it prettier! You can search for screenshots of the real game for inspiration.</p></li>
<li><p>Create a function <code>drawTile :: Integer -&gt; Picture</code> that draws a tile according to the given number<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, according to the above list. If the argument is not one of these four numbers, it should not draw anything (but should also not crash).</p></li>
<li><p>A maze can be represented as a function with the type<br />
<code>Integer -&gt; Integer -&gt; Integer</code>, which, given two coordinates, returns the kind of tile to be present there.</p>
<p>For now, we have one such maze, with the creative name <code>maze</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" title="1"><span class="ot">maze ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span></a>
<a class="sourceLine" id="cb29-2" title="2">maze x y</a>
<a class="sourceLine" id="cb29-3" title="3">  <span class="fu">|</span> <span class="fu">abs</span> x <span class="fu">&gt;</span> <span class="dv">4</span>  <span class="fu">||</span> <span class="fu">abs</span> y <span class="fu">&gt;</span> <span class="dv">4</span>  <span class="fu">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb29-4" title="4">  <span class="fu">|</span> <span class="fu">abs</span> x <span class="fu">==</span> <span class="dv">4</span> <span class="fu">||</span> <span class="fu">abs</span> y <span class="fu">==</span> <span class="dv">4</span> <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb29-5" title="5">  <span class="fu">|</span> x <span class="fu">==</span>  <span class="dv">2</span> <span class="fu">&amp;&amp;</span> y <span class="fu">&lt;=</span> <span class="dv">0</span>        <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb29-6" title="6">  <span class="fu">|</span> x <span class="fu">==</span>  <span class="dv">3</span> <span class="fu">&amp;&amp;</span> y <span class="fu">&lt;=</span> <span class="dv">0</span>        <span class="fu">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb29-7" title="7">  <span class="fu">|</span> x <span class="fu">&gt;=</span> <span class="fu">-</span><span class="dv">2</span> <span class="fu">&amp;&amp;</span> y <span class="fu">==</span> <span class="dv">0</span>        <span class="fu">=</span> <span class="dv">4</span></a>
<a class="sourceLine" id="cb29-8" title="8">  <span class="fu">|</span> <span class="fu">otherwise</span>                <span class="fu">=</span> <span class="dv">2</span></a></code></pre></div>
<p>Define a picture</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" title="1"><span class="ot">pictureOfMaze ::</span> <span class="dt">Picture</span></a></code></pre></div>
<p>which will, for every coordinate <span class="math inline">(<em>x</em>, <em>y</em>)</span> with <span class="math inline"><em>x</em>, <em>y</em> ∈  − 10, …, 10</span>, uses the <code>maze</code> above to determine what tile to place there, uses <code>drawTile</code> to draw that tile, translated into the right spot.</p>
<p>Of course, do not hard-code 441 invocations of <code>drawTile</code> into your program! Instead, use recursion to traverse the positions in the grid. You will likely need one recursive function to draw one row after another, which in turn calls a second recursive function, which then draw each element in that row.</p></li>
<li><p>Define <code>main</code> to be drawing of <code>pictureOfMaze</code>.</p></li>
</ul>
<p>The result could look like this:</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=Df4_DZK1_6UY1qogtEB89qg">
</iframe>
</section>
</section>
<section id="higher-order-functions" class="level1">
<h1><span class="header-section-number">7</span> Higher Order Functions</h1>
<p>The solution for the maze-drawing exercise might have been solved with this code, which draws a row and then draws a column:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb31-1" title="1"><span class="ot">pictureOfMaze ::</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb31-2" title="2">pictureOfMaze <span class="fu">=</span> drawRows (<span class="fu">-</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb31-3" title="3"></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="ot">drawRows ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb31-5" title="5">drawRows <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb31-6" title="6">drawRows r  <span class="fu">=</span> drawCols r (<span class="fu">-</span><span class="dv">10</span>) <span class="fu">&amp;</span> drawRows (r<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb31-7" title="7"></a>
<a class="sourceLine" id="cb31-8" title="8"><span class="ot">drawCols ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb31-9" title="9">drawCols _ <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb31-10" title="10">drawCols r c <span class="fu">=</span> drawTileAt r c <span class="fu">&amp;</span> drawCols r (c<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb31-11" title="11"></a>
<a class="sourceLine" id="cb31-12" title="12"><span class="ot">drawTileAt ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb31-13" title="13">drawTileAt <span class="fu">=</span> …</a></code></pre></div>
<p>Clearly there is some repetition going on here, with <code>drawRows</code> and <code>drawCols</code> doing very similar things. In prose, what they are doing is “21 times, do something similar each time, but varying with the count”. They differ in two aspects:</p>
<ul>
<li>The “something” is different: it is calling <code>drawCols</code> in the one case, and <code>drawTileAt</code> in the other case.</li>
<li>For <code>drawCols</code>, there is an extra argument that is passed around to the “something”.</li>
</ul>
<p>I promised that Haskell is a language with good abstractions, so it should be possible to abstract over this pattern. So lets give it a try:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" title="1">draw21times something <span class="fu">=</span> helper something (<span class="fu">-</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb32-2" title="2"></a>
<a class="sourceLine" id="cb32-3" title="3">helper something <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb32-4" title="4">helper something n  <span class="fu">=</span> something <span class="fu">&amp;</span> helper something (n<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb32-5" title="5"></a>
<a class="sourceLine" id="cb32-6" title="6">pictureOfMaze <span class="fu">=</span> draw21times drawRow</a>
<a class="sourceLine" id="cb32-7" title="7">drawRow <span class="fu">=</span> draw21times drawCol</a>
<a class="sourceLine" id="cb32-8" title="8">drawCol <span class="fu">=</span> drawTileAt <span class="fu">?</span> <span class="fu">?</span></a></code></pre></div>
<p>Now we are stuck: In the definition of <code>drawCol</code>, we need to know the current row and column number, but we do not have that! If we would write <code>n</code> (which maybe a Perl programmer from the last century would try here), we would get an error about a variable being not in scope. And even if we somehow could access the <code>n</code> there, which one would it be – <code>draw21times</code> is run twice here!</p>
<p>So the <code>helper</code> needs to pass down the <code>n</code> to <code>something</code>. And similarly, <code>drawRow</code> has to tell <code>drawCol</code> what row it is part of:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb33-1" title="1">draw21times something <span class="fu">=</span> helper something (<span class="fu">-</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb33-2" title="2"></a>
<a class="sourceLine" id="cb33-3" title="3">helper something <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb33-4" title="4">helper something n  <span class="fu">=</span> something n <span class="fu">&amp;</span> helper something (n<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb33-5" title="5"></a>
<a class="sourceLine" id="cb33-6" title="6">pictureOfMaze <span class="fu">=</span> draw21times drawRow</a>
<a class="sourceLine" id="cb33-7" title="7">drawRow r <span class="fu">=</span> draw21times (drawCol r)</a>
<a class="sourceLine" id="cb33-8" title="8">drawCol r c <span class="fu">=</span> drawTileAt r c</a></code></pre></div>
<p>Nice, so this works. But what exactly have we done here? Let us clarify things by adding type signatures, conveniently provided to us by the CodeWorld interface:</p>
<p>For <code>draw21times</code> it says</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" title="1"><span class="ot">draw21times ::</span> <span class="kw">forall</span> a<span class="fu">.</span> (<span class="dt">Eq</span> a, <span class="dt">Num</span> a) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>Now that is a mouthful. We’ll skip the details for now, but simply follow the heuristics that <code>Num a</code> says that <code>a</code> is a numeric type, so we just use <code>Integer</code>, and similarly for the other functions:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb35-1" title="1"><span class="ot">draw21times ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="ot">helper ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="ot">drawRow ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb35-4" title="4"><span class="ot">drawCol ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>The type signature of <code>draw21times</code> again has two arrows, but it does <em>not</em> take two arguments! The parenthesis around the first argument are important: This means that there is <em>one</em> argument, which happens to be a function, which itself takes <em>one</em> argument.</p>
<p>Similarly, the type signature of <code>helper</code> says that there are <em>two</em> arguments, the first being a function taking <em>one</em> argument, and the second being simply an <code>Integer</code>.</p>
<p>The types of <code>drawRow</code> and <code>drawCol</code> are again straight-forward function types. Note that the type of <code>drawRow</code> is precisely the type of the argument to <code>draw21times</code> – and therefore we can pass <code>drawRow</code> as an argument to <code>draw21times</code>.</p>
<p>What you see here is an instance of an <strong>Higher Order Function</strong>, i.e. a function that takes other functions as arguments. It is a central idea in functional programming and one main reason for the great abstraction possibilities in Haskell.</p>
<section id="partial-application" class="level2">
<h2><span class="header-section-number">7.1</span> Partial application</h2>
<p>There is something odd about the use of <code>drawCol</code> here. It seems that <code>drawCol</code> is a function of <em>two</em> parameters, but we use it with only one parameter, as an argument to <code>draw21times</code>. How can that work?</p>
<p>To understand that, let me write the type signature of <code>drawCol</code> differently:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb36-1" title="1"><span class="ot">drawCol ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>)</a></code></pre></div>
<p>This suddenly changes the perspective: Now <code>drawCol</code> is a function taking <em>one</em> argument, and returning <em>another</em> function, which again takes one argument. And this returned function nicely fits the argument type of <code>draw21times</code>.</p>
<p>But it really is just a change of perspective. The two types are identical. In this sense, every function in Haskell takes one argument – it is just that some return a function.</p>
<p>You can also understand that from looking at a function call. The expression <code>f x y</code> is equivalent to <code>(f x) y</code>.</p>
<p>We note that the function type arrow is <em>right associative</em> and function application is <em>left associative</em>.</p>
</section>
<section id="local-definitions" class="level2">
<h2><span class="header-section-number">7.2</span> Local definitions</h2>
<p>Let us clean up the code a bit. First of all, the definition <code>drawCol r c = drawTileAt r c</code> looks quite useless. All it says is that “using <code>drawCol</code> is equivalent to using <code>drawTileAt</code>”. So let us remove <code>drawCol</code>.</p>
<p>The next code smell is the <code>helper</code> function. It really is a helper to <code>draw21times</code>, so it would be nice to have this function only available within <code>draw21times</code>. To do so, we use local definitions. They come in two varieties:</p>
<ol type="1">
<li><p>As <code>let</code>-bindings:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb37-1" title="1"><span class="ot">draw21times ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb37-2" title="2">draw21times something <span class="fu">=</span></a>
<a class="sourceLine" id="cb37-3" title="3">  <span class="kw">let</span><span class="ot"> helper ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb37-4" title="4">      helper something <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb37-5" title="5">      helper something n  <span class="fu">=</span> something n <span class="fu">&amp;</span> helper something (n<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb37-6" title="6">  <span class="kw">in</span> helper something (<span class="fu">-</span><span class="dv">10</span>)</a></code></pre></div>
<p>A <code>let</code>-binding contains definitions for functions and values, quite like top-level definitions. It can contain multiple definitions, and makes them available to both the definitions it contains, as well as to the expression after the <code>in</code>. The <code>let</code>-construct is a self-contained expression and can be used wherever any other expression is expected.</p></li>
<li><p>In a <code>where</code>-clause:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb38-1" title="1"><span class="ot">draw21times ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb38-2" title="2">draw21times something <span class="fu">=</span> helper something (<span class="fu">-</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb38-3" title="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb38-4" title="4"><span class="ot">    helper ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb38-5" title="5">    helper something <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb38-6" title="6">    helper something n  <span class="fu">=</span> something n <span class="fu">&amp;</span> helper something (n<span class="fu">+</span><span class="dv">1</span>)</a></code></pre></div>
<p>This is just a syntactic variation, and equivalent to the code above. One or more definitions can follow the <code>where</code>, and are available to those definitions and the body of the function.</p></li>
</ol>
<p>It is a matter of style which ones to use. Generally, <code>where</code> clauses are prettier, require less indentation and are almost always used for local functions. They also have the advantage of scoping over multiple guards. For local values (e.g. some computation), a <code>let</code> clause can also work well. You’ll get the hang of it.</p>
<p>A more common name for such a local definition is simply <code>go</code>. It is ok to use such a non-descript name, because its scope is so small and clearly defined. Also, type signatures for such local definitions are often omitted.</p>
</section>
<section id="captured-variables" class="level2">
<h2><span class="header-section-number">7.3</span> Captured variables</h2>
<p>Making <code>go</code> a local function and moving it into <code>draw21times</code> has another advantage: It can reference the parameters of <code>draw21times</code>. Currently, <code>go</code> goes through quite some lengths to pass the <code>something</code> parameter around. But that is no longer necessary: It can simply refer to <code>something</code> as it is bound by <code>draw21times</code>:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb39-1" title="1"><span class="ot">draw21times ::</span> (<span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb39-2" title="2">draw21times something <span class="fu">=</span> go (<span class="fu">-</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb39-3" title="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb39-4" title="4">    go <span class="dv">11</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb39-5" title="5">    go n  <span class="fu">=</span> something n <span class="fu">&amp;</span> go (n<span class="fu">+</span><span class="dv">1</span>)</a></code></pre></div>
</section>
<section id="a-note-on-indentation" class="level2">
<h2><span class="header-section-number">7.4</span> A note on indentation</h2>
<p>By now you might have noticed that indentation seems to be significant in Haskell – how else would you know where the <code>where</code> clause ends. Indeed, like Python, but unlike most other programming languages, Haskell is indentation sensitive. This has two advantages:</p>
<ul>
<li>There is no need for delimiters like curly braces etc, which makes the code cleaner and easier to read.</li>
<li>It ensures that the programmer writes properly indented code.</li>
</ul>
<p>The indentation rules are somewhat technical, so I will <em>not</em> explain them here. Instead, I appeal to intuition: From the examples given in class and the exercises, you will soon get an intuition about how that works, and that will be sufficient. In fact, I myself cannot give you the exact rules, but I have not had a problem with indentation since many years.</p>
<p>If it does not work: Experiment. If you are stuck: Ask (e.g. on Piazza).</p>
<p>If you really want to know the rules start with the <a href="https://en.wikibooks.org/wiki/Haskell/Indentation">chapter on indentation</a> in the Wikibook on Haskell.</p>
</section>
<section id="lambda-expressions" class="level2">
<h2><span class="header-section-number">7.5</span> Lambda expressions</h2>
<p>We have now seen already three way of defining a function: Global, in a <code>let</code> or in an <code>where</code> clause. The form of the definition has always been the same, though, and all of them required giving a name to the thing.</p>
<p>Giving a name is not always desired. Naming things is hard! Therefore, at least for very small functions that are used only once, it is desirable to just define them on the spot where they are used.</p>
<p>Consider the <code>drawRow</code> function: All it does is to call <code>draw21times</code> with <code>drawTileAt</code> as its argument. That is hardly worth giving a name, writing a type signature and so on.</p>
<p>So instead of using <code>drawRow</code>, we can define this functionality right on the spot in <code>pictureOfMaze</code>:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb40-1" title="1">pictureOfMaze <span class="fu">=</span> draw21times (\r <span class="ot">-&gt;</span> draw21times (drawTileAt r))</a></code></pre></div>
<p>The <code>backslash</code> is a poor rendering of the Greek letter λ (lambda), and indicates that this defines an anonymous, local function, which, when called, takes one parameter <code>r</code>, and returns the stuff after the right arrow, i.e. <code>draw21times (drawTileAt r)</code>.</p>
<p>We could use it twice to make it a bit clearer what this code does, by naming the variables for the row and the column appropriately, and also showing the symmetry:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb41-1" title="1">pictureOfMaze <span class="fu">=</span> draw21times (\r <span class="ot">-&gt;</span> draw21times (\c <span class="ot">-&gt;</span> drawTileAt r c))</a></code></pre></div>
<p>Higher order functions, local functions and lambda expressions allow for very concise, but yet readable code. Use it!</p>
<p>You can see the <a href="https://code.world/haskell#P58_NZPEKBOlJhmHKitZ3Og">final code on CodeWorld</a>.</p>
</section>
</section>
<section id="data-types" class="level1">
<h1><span class="header-section-number">8</span> Data types</h1>
<p>On to the next topic, and again we will motivate and introduce it by addressing some wart in the code from the last set of exercises.</p>
<p>The functions <code>drawTile</code> and <code>maze</code> designate the different types of tiles by a number. That calls for trouble: It is easy to mix them up, extending the list of tiles is error-prone, as you might forget to extend the code somewhere else that handles the numbers.</p>
<p>The problem is that <code>Integers</code> are not a a suitable type to represent tiles: There are too many of them, and their meaning is implicit.</p>
<p>So we want a type that is <em>tight</em>, i.e. large enough to encompass all tiles we want to represent, but no more, and <em>explicit</em>, i.e. the meaning of a value of such a type is clear.</p>
<p>So we simply introduce such a type:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb42-1" title="1"><span class="kw">data</span> <span class="dt">Tile</span> <span class="fu">=</span> <span class="dt">Wall</span> <span class="fu">|</span> <span class="dt">Ground</span> <span class="fu">|</span> <span class="dt">Storage</span> <span class="fu">|</span> <span class="dt">Box</span> <span class="fu">|</span> <span class="dt">Blank</span></a></code></pre></div>
<p>The keyword is <code>data</code>, followed by the name of the new type, followed by an equals sign, followed by a list of <em>constructors</em> of this type, separated by bars. Type and constructor names always start with a capital letter, and they each have their own namespace (so you can use the same name for a type and a constructor).</p>
<p>The new type <code>Tile</code> now consists of exactly these five constructors as values, no more and no less. So the type is tight. And further more, every value is self-explanatory.</p>
<p>We can return them in <code>maze</code>, and pattern match in <code>drawTile</code>, just like with numbers (<a href="https://code.world/haskell#PbMQ7glVWM64KW5nzbGuyZA">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb43-1" title="1"><span class="ot">drawTile ::</span> <span class="dt">Tile</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb43-2" title="2">drawTile <span class="dt">Wall</span>    <span class="fu">=</span> wall</a>
<a class="sourceLine" id="cb43-3" title="3">drawTile <span class="dt">Ground</span>  <span class="fu">=</span> ground</a>
<a class="sourceLine" id="cb43-4" title="4">drawTile <span class="dt">Storage</span> <span class="fu">=</span> storage</a>
<a class="sourceLine" id="cb43-5" title="5">drawTile <span class="dt">Box</span>     <span class="fu">=</span> box</a>
<a class="sourceLine" id="cb43-6" title="6">drawTile <span class="dt">Blank</span>   <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb43-7" title="7"></a>
<a class="sourceLine" id="cb43-8" title="8"><span class="ot">maze ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Tile</span></a>
<a class="sourceLine" id="cb43-9" title="9">maze x y</a>
<a class="sourceLine" id="cb43-10" title="10">  <span class="fu">|</span> <span class="fu">abs</span> x <span class="fu">&gt;</span> <span class="dv">4</span>  <span class="fu">||</span> <span class="fu">abs</span> y <span class="fu">&gt;</span> <span class="dv">4</span>  <span class="fu">=</span> <span class="dt">Blank</span></a>
<a class="sourceLine" id="cb43-11" title="11">  <span class="fu">|</span> <span class="fu">abs</span> x <span class="fu">==</span> <span class="dv">4</span> <span class="fu">||</span> <span class="fu">abs</span> y <span class="fu">==</span> <span class="dv">4</span> <span class="fu">=</span> <span class="dt">Wall</span></a>
<a class="sourceLine" id="cb43-12" title="12">  <span class="fu">|</span> x <span class="fu">==</span>  <span class="dv">2</span> <span class="fu">&amp;&amp;</span> y <span class="fu">&lt;=</span> <span class="dv">0</span>        <span class="fu">=</span> <span class="dt">Wall</span></a>
<a class="sourceLine" id="cb43-13" title="13">  <span class="fu">|</span> x <span class="fu">==</span>  <span class="dv">3</span> <span class="fu">&amp;&amp;</span> y <span class="fu">&lt;=</span> <span class="dv">0</span>        <span class="fu">=</span> <span class="dt">Storage</span></a>
<a class="sourceLine" id="cb43-14" title="14">  <span class="fu">|</span> x <span class="fu">&gt;=</span> <span class="fu">-</span><span class="dv">2</span> <span class="fu">&amp;&amp;</span> y <span class="fu">==</span> <span class="dv">0</span>        <span class="fu">=</span> <span class="dt">Box</span></a>
<a class="sourceLine" id="cb43-15" title="15">  <span class="fu">|</span> <span class="fu">otherwise</span>                <span class="fu">=</span> <span class="dt">Ground</span></a></code></pre></div>
<p>Note how suddenly the type signature of <code>drawTile</code> and especially of <code>maze</code> has become much more helpful!</p>
<section id="booleans" class="level2">
<h2><span class="header-section-number">8.1</span> Booleans</h2>
<p>You have actually used such a datatype before, in last week’s class: We were using the type <code>Bool</code>, with its values <code>True</code> and <code>False</code>. And it may come as a surprise to you that this type is defined using the very same mechanism that you just leaned:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb44-1" title="1"><span class="kw">data</span> <span class="dt">Bool</span> <span class="fu">=</span> <span class="dt">False</span> <span class="fu">|</span> <span class="dt">True</span></a></code></pre></div>
<p>It is a sign of good programming language design if many concepts can be implemented using the language itself, instead of having to be built in.</p>
<p>The same then holds for operators like <code>(||)</code> and <code>(&amp;&amp;)</code> – there is nothing special about them, and you could have defined them yourself. (Try to come up with their definition, and then compare it against the real one!)</p>
<p>The type is still somewhat privileged though, because guards, like the one in <code>maze</code>, need to be expressions of type <code>Bool</code>. But that’s just a use of the type, not the definition of the type.</p>
</section>
<section id="more-data-types-for-sokoban" class="level2">
<h2><span class="header-section-number">8.2</span> More data types for Sokoban</h2>
<p>Let us work towards making our animation interactive. To start with, we might want to move the maze around, using the keyboard, in case it is larger than our screen (or just as a preparation for moving the player around).</p>
<p>To that end, let us first talk about the types involved. It makes sense to have one type that describes the possible ways to interact with the system. For now, the only interaction is moving the view into one of the four directions, so we can define a data type for that:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb45-1" title="1"><span class="kw">data</span> <span class="dt">Direction</span> <span class="fu">=</span> <span class="dt">R</span> <span class="fu">|</span> <span class="dt">U</span> <span class="fu">|</span> <span class="dt">L</span> <span class="fu">|</span> <span class="dt">D</span></a></code></pre></div>
<p>We also need to keep track of the current position, after a few key presses. Now, there are infinitely many possible positions, so a simple enumeration does not cut it. We could describe the position with two integer numbers, so we need a type that stores two such numbers. We can do that also using the <code>data</code> keyword, and giving the <em>parameters</em> to the constructor:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb46-1" title="1"><span class="kw">data</span> <span class="dt">Coord</span> <span class="fu">=</span> <span class="dt">C</span> <span class="dt">Integer</span> <span class="dt">Integer</span></a></code></pre></div>
<p>Here I define the type <code>Coord</code>. There is a single constructor to created this type, called <code>C</code>, which takes two <code>Integer</code>s and turns them into one <code>Coord</code>.</p>
<p>Just like above, the constructors are value we can use in expressions, we can do this with <code>C</code>, which is a function of type <code>Integer -&gt; Integer -&gt; Coord</code>.</p>
<p>If you like math-talk: The type <code>Coord</code> is now isomorphic to the product type of <code>Integer</code> with <code>Integer</code>, and <code>C</code> is an isomorphism between them. If follows that constructors are always injective, and if that does not mean anything to you right now, you can ignore this.</p>
<p>Here is an example use of <code>C</code> as a function:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb47-1" title="1"><span class="ot">initialCoord ::</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb47-2" title="2">initialCoord <span class="fu">=</span> <span class="dt">C</span> <span class="dv">0</span> <span class="dv">0</span></a></code></pre></div>
<p>So it is straight forward to create a <code>Coord</code> (just use the constructor as a function). How do we use a <code>Coord</code>? This works by pattern matching. We will need a function that translates a picture to have its origin at a given coordinate. Let us write it, first thinking about the type and then the code:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb48-1" title="1"><span class="ot">atCoord ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb48-2" title="2">atCoord (<span class="dt">C</span> x y) pic <span class="fu">=</span> translated (<span class="fu">fromIntegral</span> x) (<span class="fu">fromIntegral</span> y) pic</a></code></pre></div>
<p>So when we pattern match against a constructor with parameters, we simply give names to the parameters. We have to put parentheses around this, to distinguish it from multiple function parameters – this applies consistently in pattern just as well as in expressions.</p>
<p>(The <code>fromIntegral</code> is needed to convert the <code>Integer</code> to a <code>Double</code>. Why did we not put <code>Double</code> in the type of <code>Coord</code> in the first place? Because <code>Integer</code> is more honest: If we just use the keyboard, there will never be non-integral coordinates there.)</p>
<p>The next function that we will want to write is one that calculates a new coordinate, based on the current coordinate and a direction.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb49-1" title="1"><span class="ot">adjacentCoord ::</span> <span class="dt">Direction</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb49-2" title="2">adjacentCoord <span class="dt">R</span> (<span class="dt">C</span> x y) <span class="fu">=</span> <span class="dt">C</span> (x<span class="fu">+</span><span class="dv">1</span>) y</a>
<a class="sourceLine" id="cb49-3" title="3">adjacentCoord <span class="dt">U</span> (<span class="dt">C</span> x y) <span class="fu">=</span> <span class="dt">C</span>  x   (y<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb49-4" title="4">adjacentCoord <span class="dt">L</span> (<span class="dt">C</span> x y) <span class="fu">=</span> <span class="dt">C</span> (x<span class="fu">-</span><span class="dv">1</span>) y</a>
<a class="sourceLine" id="cb49-5" title="5">adjacentCoord <span class="dt">D</span> (<span class="dt">C</span> x y) <span class="fu">=</span> <span class="dt">C</span>  x   (y<span class="fu">-</span><span class="dv">1</span>)</a></code></pre></div>
<p>That was a lot of coding without seeing anything. Let us try it out (<a href="https://code.world/haskell#POm0GIN2vx3ZD_3OW2kUE9A">also on CodeWorld</a>):</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb50-1" title="1"><span class="ot">someCoord ::</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb50-2" title="2">someCoord <span class="fu">=</span> adjacentCoord <span class="dt">U</span> (adjacentCoord <span class="dt">U</span> (adjacentCoord <span class="dt">L</span> initialCoord))</a>
<a class="sourceLine" id="cb50-3" title="3"></a>
<a class="sourceLine" id="cb50-4" title="4">main <span class="fu">=</span> drawingOf (atCoord someCoord pictureOfMaze)</a></code></pre></div>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DpmMHe9fq7X5Bm2pfIKGlmg">
</iframe>
</section>
</section>
<section id="pure-interaction" class="level1">
<h1><span class="header-section-number">9</span> Pure Interaction</h1>
<p>Time to put these thing to good use. The goal is as follows: The maze should be centered when we start the program. Then we can use the arrow keys to move it around. We have already implemented most functionality for that, but you might wonder: How can we have interaction in a world without side-effects? How can we remember the current state in a world without mutable variables?</p>
<p>Well, we solved such a riddle before, when we implemented an animation, by modeling our thoughts in terms of pure functions, and then having some “machinery” that executes our pure functions, yielding the desired effect. We can do it again.</p>
<p>An interactive program changes state whenever a new input event happens. If we want to separate the logic of the state change from the logic of remembering the current state, the former becomes a pure function again, namely one that, given the input event and the current state, calculates the new state. Additionally, we need to specify the initial state, and then of course how to visualize the state.</p>
<section id="interaction-on-codeworld" class="level2">
<h2><span class="header-section-number">9.1</span> Interaction on CodeWorld</h2>
<p>This functionality is provided in CodeWorld by the following function, which has quite a large type signature:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb51-1" title="1"><span class="ot">activityOf ::</span> world <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb51-2" title="2">              (<span class="dt">Event</span> <span class="ot">-&gt;</span> world <span class="ot">-&gt;</span> world) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb51-3" title="3">              (world <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb51-4" title="4">              <span class="dt">IO</span> ()</a></code></pre></div>
<p>Its type signature mentions the type <code>world</code>. This is not a specific type, but rather a type variable. We’ll get to that later; all we need to know for now is that this type can be any type we want it to be. This type contains the state of the program. In our case, it is simply a <code>Coord</code>.</p>
<p>The function <code>activityOf</code> takes three arguments:</p>
<ol type="1">
<li>An initial state.</li>
<li>A function modifying the state if a certain event has happened. An event is either some action by the user, or simply the passing of time.</li>
<li>A function to draw a picture according to the current state.</li>
</ol>
<p>Let us try to use this function, in a simple way, where we simply move the maze up on each event (<a href="https://code.world/haskell#Pd3BDS87zJeSRTtIj44bKkA">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb52-1" title="1">main <span class="fu">=</span> activityOf initialCoord handleEvent drawState</a>
<a class="sourceLine" id="cb52-2" title="2"></a>
<a class="sourceLine" id="cb52-3" title="3"><span class="ot">handleEvent ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb52-4" title="4">handleEvent e c <span class="fu">=</span> adjacentCoord <span class="dt">U</span> c</a>
<a class="sourceLine" id="cb52-5" title="5"></a>
<a class="sourceLine" id="cb52-6" title="6"><span class="ot">drawState ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb52-7" title="7">drawState c <span class="fu">=</span> atCoord c pictureOfMaze</a></code></pre></div>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DHrxJurWrtSZuL05xCBuefA">
</iframe>
<p>That does … something. But very quickly, the maze disappears. Which makes sense, as the passing of time and mouse movements are also events.</p>
</section>
<section id="events" class="level2">
<h2><span class="header-section-number">9.2</span> Events</h2>
<p>So we need to look at the <code>Event</code> type. According to the documentation, it is a data type. We know data types!</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">data</span> <span class="dt">Event</span> <span class="fu">=</span> <span class="dt">KeyPress</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb53-2" title="2">           <span class="fu">|</span> <span class="dt">KeyRelease</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb53-3" title="3">           <span class="fu">|</span> <span class="dt">PointerPress</span> <span class="dt">Point</span></a>
<a class="sourceLine" id="cb53-4" title="4">           <span class="fu">|</span> <span class="dt">PointerRelease</span> <span class="dt">Point</span></a>
<a class="sourceLine" id="cb53-5" title="5">           <span class="fu">|</span> <span class="dt">PointerMovement</span> <span class="dt">Point</span></a>
<a class="sourceLine" id="cb53-6" title="6">           <span class="fu">|</span> <span class="dt">TextEntry</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb53-7" title="7">           <span class="fu">|</span> <span class="dt">TimePassing</span> <span class="dt">Double</span></a></code></pre></div>
<p>There are seven constructors, for different kind of events. We care about <code>KeyPress</code> events. This constructor has an argument, which is a <code>Text</code>. We have not seen this type before, but we can guess what it means. So let us handle this (<a href="https://code.world/haskell#PhQSOQfMcP7q2P5OhfGEFWQ">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb54-1" title="1"><span class="ot">handleEvent ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb54-2" title="2">handleEvent (<span class="dt">KeyPress</span> key) c</a>
<a class="sourceLine" id="cb54-3" title="3">    <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Right&quot;</span> <span class="fu">=</span> adjacentCoord <span class="dt">R</span> c</a>
<a class="sourceLine" id="cb54-4" title="4">    <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Up&quot;</span>    <span class="fu">=</span> adjacentCoord <span class="dt">U</span> c</a>
<a class="sourceLine" id="cb54-5" title="5">    <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Left&quot;</span>  <span class="fu">=</span> adjacentCoord <span class="dt">L</span> c</a>
<a class="sourceLine" id="cb54-6" title="6">    <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Down&quot;</span>  <span class="fu">=</span> adjacentCoord <span class="dt">D</span> c</a>
<a class="sourceLine" id="cb54-7" title="7">handleEvent _ c      <span class="fu">=</span> c</a></code></pre></div>
<p>From now on, make sure you have the line <code>{-# LANGUAGE OverloadedStrings #-}</code> at the very top of your file, or you will get strange error messages.</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DU9Rc5WmCKjq70Qr9mvIqPQ">
</iframe>
<p>And there we go, we can move the maze around! (You might have to click on the embedded picture before it reacts to your key presses.)</p>
</section>
<section id="some-terminology" class="level2">
<h2><span class="header-section-number">9.3</span> Some terminology</h2>
<ul>
<li><p>A data type where none of the constructors has parameters is called an <em>enumeration type</em>.</p></li>
<li><p>A data type with exactly one constructor is called a <em>product type</em>.</p></li>
<li><p>A data type with multiple constructors is called a <em>sum type</em>.</p></li>
<li><p>A data type with no constructors is an <em>empty type</em>. Yes, that is a thing. Yes, this is sometimes useful.</p></li>
</ul>
<!--

Keep this for the introduction of Maybe...

Resetting the stage
===================

Let us add another way of interacting with the program: Pressing the escape key should reset everything.

Adding this functionality is quite simple: Just add another line to `handleEvent`:

```haskell
    | key == "Down"  = adjacentCoord D c
```

But this is not pleasing: The function `handleEvent` is getting large, and is
mixing two different things: Deciphering the `Event` type, and actually
performing the event. So let us separate these two, and define a clear
interface for our game. For that, we want to define a datatype.

What interactions do we have now? All four directions, plus reset. It would not be wise to add `Reset` to the directions, as `Reset` is not a direction. It would also not be wise to simply create a new data type with five constructors, as we would be duplicating the structure of directions.

So we want a data type that is either a direction (and use `Direction` there), or a reset command. We thus need to constructors, one of which has a `Direction` as a parameter:

```haskell
data Command = Goto Direction | Reset
```

We then split `handleEvent` into `parseEvent`
-->
<p>With that knowledge (and some cleverness) you should already be able to write a fully functional Sokoban, although we will use the next set of exercises for some more preliminaries, and then learn a bit more that will help us finish the game.</p>
</section>
</section>
<section id="exercises-1" class="level1 exercises">
<h1><span class="header-section-number">10</span> ✍️ Exercises</h1>
<p>You are free to use the <a href="https://code.world/haskell#PhQSOQfMcP7q2P5OhfGEFWQ">code from above</a> and from your own solutions to the first set of exercises. Some of the exercises below reference types and functions from there. In particular, if you have nicely drawn tiles, you should use them instead of my ugly ones.</p>
<p>You learned about local definitions and lambda expressions. Use them when appropriate!</p>
<section id="the-small-guy-or-girl-moves" class="level2">
<h2><span class="header-section-number">10.1</span> The small guy (or girl) moves</h2>
<p>We hope to have a complete game soon, so let us work towards that.</p>
<p>Create a value <code>player :: Picture</code> that draws your figure.</p>
<p>Create a value <code>main :: IO ()</code> that calls <code>activityOf</code> with suitable arguments that:</p>
<ul>
<li>the player is drawn on top of the maze,</li>
<li>it starts in a position where there is ground (you can hard-code that position),</li>
<li>the cursor keys move the figure around (while the maze stays in a fixed position),</li>
<li>the player moves only on tiles of type <code>Ground</code> and <code>Storage</code>. Trying to move it into any other position will simply leave it in place.</li>
</ul>
<p>It might yield nicer code to change the type of <code>maze</code> to <code>Coord -&gt; Tile</code>. If you find that, do not hesitate to make that change.</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=Dc_b4IxNW5al9Tdbd6lWjLw">
</iframe>
</section>
<section id="look-the-right-way" class="level2">
<h2><span class="header-section-number">10.2</span> Look the right way!</h2>
<p>This is a continuation of the previous exercise. We want the figure to look the way it is going. So change the type of <code>player</code> to <code>player :: Direction -&gt; Picture</code> that draws the figure in four variants.</p>
<p>Then extend the code from above so that after the player has tried to move in some direction, it looks that way.</p>
<p>Hint: Think about types first (e.g of your state), and then about the implementation.</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=Dr4pJqT05HUuOSmv2njd9qg">
</iframe>
</section>
<section id="reset" class="level2">
<h2><span class="header-section-number">10.3</span> Reset!</h2>
<p>It would be nice to be able to start a game from the beginning. This is generally useful functionality, no matter what the game, so let us implement it generally.</p>
<p>Write a function</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb55-1" title="1"><span class="ot">resetableActivityOf ::</span></a>
<a class="sourceLine" id="cb55-2" title="2">    world <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb55-3" title="3">    (<span class="dt">Event</span> <span class="ot">-&gt;</span> world <span class="ot">-&gt;</span> world) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb55-4" title="4">    (world <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb55-5" title="5">    <span class="dt">IO</span> ()</a></code></pre></div>
<p>which has the same type as <code>activityOf</code>.</p>
<p>This function will behave almost the same as <code>activityOf</code> (which it internally uses, of course), but when <code>Esc</code> is pressed, this event is not passed on, but rather the state of the program is reset to the given initial state.</p>
<p>Style hint: An idiomatic definition of <code>resetableActivityOf</code> does not require any other top-level definitions, but likely local functions and/or lambda expressions.</p>
<p>Let <code>exercise3</code> be like <code>exercise2</code>, but using <code>resetableActivityOf</code> instead of <code>activityOf</code>.</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=Ds_7PpypE0pjLFSY8qNcRTA">
</iframe>
</section>
<section id="new-level-optional" class="level2">
<h2><span class="header-section-number">10.4</span> New level (optional)</h2>
<p>Create your own maze. It should</p>
<ul>
<li>fit within the screen (i.e. use coordinates from -10 to 10),</li>
<li>it should be connected (i.e. starting on a ground tile, and disregarding boxes, the player should be able to reach all ground tiles),</li>
<li>it should be closed (i.e. the player should not be able to reach blank tiles), and</li>
<li>it should be solvable (recollect <a href="https://en.wikipedia.org/wiki/Sokoban#Rules">the rules</a> if necessary).</li>
</ul>
</section>
</section>
<section id="polymorphism" class="level1">
<h1><span class="header-section-number">11</span> Polymorphism</h1>
<p>Now, we will explore how polymorphism allows for yet more abstract and compositional thinking, and how to apply wholemeal programming.</p>
<p>Polymorphism is a property of a function that it can work with any type. We have seen this in the type signature of <code>activityOf</code>:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb56-1" title="1"><span class="ot">activityOf ::</span> world <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb56-2" title="2">              (<span class="dt">Event</span> <span class="ot">-&gt;</span> world <span class="ot">-&gt;</span> world) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb56-3" title="3">              (world <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb56-4" title="4">              <span class="dt">IO</span> ()</a></code></pre></div>
<p>This function is polymorphic because the type <code>world</code> is arbitrary, and can be chosen by the caller. We did that in last week’s class when we instantiated with <code>Coord</code>, and you did it again in the homework, using your custom <code>State</code> type.</p>
<section id="parametricity" class="level2">
<h2><span class="header-section-number">11.1</span> Parametricity</h2>
<p>It is important to keep in mind that <em>the caller picks the type</em>. Therefore, the implementation has to be able to handle any possible type. And since in Haskell you cannot make decisions based on the type of an argument (only on the value of the argument), this implies that Haskell is <strong>parametric</strong>: Polymorphic code behaves “the same” for any type that you pass it to.</p>
<p>Why is parametricity important?</p>
<ol type="1">
<li><p>It makes <strong>type erasure</strong> possible. Type erasure means that no information about the type of values is present at run-time. The compiler erases the types from your program as it compiles it to machine code. The benefit is that he code runs much faster than, say, Python code, where type information needs to be carried around and inspected at run-time.</p></li>
<li><p>It restricts what polymorphic functions can do. Consider the following type signature:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb57-1" title="1"><span class="ot">riddle ::</span> a <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>We do not see its implementation. What can we say about it?</p>
<p>It will have to return a value of type <code>a</code>, in a way that works for every possible type. So it cannot return <code>3</code>, it cannot return <code>True</code>. The only value of type <code>a</code> that it has access to is its parameter. So the only sensible definition of this function is</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb58-1" title="1"><span class="ot">riddle ::</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb58-2" title="2">riddle x <span class="fu">=</span> x</a></code></pre></div>
<p>Similarly, consider a function</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb59-1" title="1"><span class="ot">riddle2 ::</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>which takes two arguments: a function, and a value, again of some type that <code>riddle2</code> cannot know anything about. We can again wonder: What values of type <code>a</code> can <code>riddle2</code> return? Well, it can return its second argument. Or it can apply its first argument (the function) to the second argument. Or it can apply it twice… so there are many possible <code>riddle2</code> implementations, but we still can tell a lot about them from the type signature:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb60-1" title="1"><span class="ot">riddle2 ::</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb60-2" title="2">riddle2 f x <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb60-3" title="3">riddle2 f x <span class="fu">=</span> f x</a>
<a class="sourceLine" id="cb60-4" title="4">riddle2 f x <span class="fu">=</span> f (f x)</a>
<a class="sourceLine" id="cb60-5" title="5">…</a></code></pre></div>
<p>Try yourself: What can you know about a function with this type:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb61-1" title="1"><span class="ot">riddle3 ::</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb61-2" title="2">…</a></code></pre></div>
<p>What about this riddle:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb62-1" title="1"><span class="ot">riddle4 ::</span> a <span class="ot">-&gt;</span> b</a></code></pre></div>
<p>Such a function cannot be written in Haskell! <code>riddle4</code> has no way of producing a value that will work as any possible type <code>b</code>!</p>
<p>If you want to learn more about what one can find out about a function from its polymorphic type, read up on <em>free theorems</em>.</p></li>
</ol>
<p>The above is not completely accurate. It is possible to implement a function of type <code>riddle4</code>:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb63-1" title="1"><span class="ot">riddle4 ::</span> a <span class="ot">-&gt;</span> b</a>
<a class="sourceLine" id="cb63-2" title="2">riddle4 x <span class="fu">=</span> riddle4 x</a></code></pre></div>
<p>But this function will send the program into a infinite loop. The above observations are true for <em>total</em> functions, i.e. functions that always return. Haskell does allow for partial functions (i.e. functions that go into an infinite loop, or that throw an exception).</p>
</section>
<section id="polymorphic-data-types" class="level2">
<h2><span class="header-section-number">11.2</span> Polymorphic Data Types</h2>
<p>Not only functions can be polymorphic, but also data types. Let us motivate that by an example.</p>
<p>In last week’s homework (<a href="https://code.world/haskell#PrNG93LfJGfUpZlp8Vt_TRg">example solution</a>), we created a variant of <code>activityOf</code> that would allow the game to be reset (and it was indeed polymorphic). Let us do something similar and create a variant of <code>activityOf</code> that would initially show a startup-screen, and start the game proper only when the space key is pressed.</p>
<p>We define a very simple start screen:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb64-1" title="1"><span class="ot">startScreen ::</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb64-2" title="2">startScreen <span class="fu">=</span> scaled <span class="dv">3</span> <span class="dv">3</span> (lettering <span class="st">&quot;Sokoban!&quot;</span>)</a></code></pre></div>
<p>In order to implement this functionality, we need, in the state, remember whether we are showing the start screen, or whether we are already playing the game. But the type of <code>startScreenActivityOf</code> (which is the same as <code>activityOf</code>) needs to be polymorphic in the state! We do not know what kind of state is used for the interaction we are wrapping, so we cannot use it to find out whether we are showing the start screen or not!</p>
<p>So we need to define our own state data type. And clearly, it is in one of two states: It is either showing the start screen, or the game is running, in which case we need to hold the game’s state. We can define a data type that does that:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb65-1" title="1"><span class="kw">data</span> <span class="dt">SSState</span> <span class="fu">=</span> <span class="dt">StartScreen</span> <span class="fu">|</span> <span class="dt">Running</span> world</a></code></pre></div>
<p>With this code, we get the error message <code>Not in scope: type variable ‘world’</code>. To fix this, we have to give the type <code>SSState</code> a <em>type parameter</em>:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb66-1" title="1"><span class="kw">data</span> <span class="dt">SSState</span> world <span class="fu">=</span> <span class="dt">StartScreen</span> <span class="fu">|</span> <span class="dt">Running</span> world</a></code></pre></div>
<p>So while <code>SSState</code> on its own is not a proper type yet, <code>SSState</code> applied to any type (e.g. <code>SSState Coord</code>) is.</p>
<p>Now we can implement the bits required for `startScreenActivityOf:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb67-1" title="1"><span class="ot">startScreenActivityOf ::</span></a>
<a class="sourceLine" id="cb67-2" title="2">    world <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb67-3" title="3">    (<span class="dt">Event</span> <span class="ot">-&gt;</span> world <span class="ot">-&gt;</span> world) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb67-4" title="4">    (world <span class="ot">-&gt;</span> <span class="dt">Picture</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb67-5" title="5">    <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb67-6" title="6">startScreenActivityOf state0 handle draw</a>
<a class="sourceLine" id="cb67-7" title="7">  <span class="fu">=</span> activityOf state0&#39; handle&#39; draw&#39;</a>
<a class="sourceLine" id="cb67-8" title="8">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb67-9" title="9">    state0&#39; <span class="fu">=</span> <span class="dt">StartScreen</span></a>
<a class="sourceLine" id="cb67-10" title="10"></a>
<a class="sourceLine" id="cb67-11" title="11">    handle&#39; (<span class="dt">KeyPress</span> key) <span class="dt">StartScreen</span></a>
<a class="sourceLine" id="cb67-12" title="12">         <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot; &quot;</span>                  <span class="fu">=</span> <span class="dt">Running</span> state0</a>
<a class="sourceLine" id="cb67-13" title="13">    handle&#39; _              <span class="dt">StartScreen</span> <span class="fu">=</span> <span class="dt">StartScreen</span></a>
<a class="sourceLine" id="cb67-14" title="14">    handle&#39; e              (<span class="dt">Running</span> s) <span class="fu">=</span> <span class="dt">Running</span> (handle e s)</a>
<a class="sourceLine" id="cb67-15" title="15"></a>
<a class="sourceLine" id="cb67-16" title="16">    draw&#39; <span class="dt">StartScreen</span> <span class="fu">=</span> startScreen</a>
<a class="sourceLine" id="cb67-17" title="17">    draw&#39; (<span class="dt">Running</span> s) <span class="fu">=</span> draw s</a></code></pre></div>
<p>It was easy to write down the code, because we can program in a type-driven manner: With the type of the local functions in mind, we could simply program by cases. Every case on its own is rather obvious, and once we handled all the cases, we have a working program. (<a href="https://code.world/haskell#P_gdc8AWX5FDr4hjVKvsuQQ">Open on CodeWorld</a>)</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DN9xS0uKpjs7T8mZQPx0N2A">
</iframe>
</section>
<section id="wholemeal-interactions" class="level2">
<h2><span class="header-section-number">11.3</span> Wholemeal interactions</h2>
<p>We now have this nice start screen, so it is a bit unfortunate that once we start the game, we cannot go back and see it again. So we really would want to combine this functionality with the reset functionality that we did in last week’s homework. But we can’t! Both these generic interaction-modifiers produce complete programs, there is no way to apply one to the other.</p>
<p>Surely, we can do better.</p>
<p>Imagine we had a type <code>Activity</code> that captures everything about an activity. What if we then also had functions</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb68-1" title="1"><span class="ot">resetable ::</span> <span class="dt">Activity</span> <span class="ot">-&gt;</span> <span class="dt">Activity</span></a>
<a class="sourceLine" id="cb68-2" title="2"><span class="ot">withStartScreen ::</span> <span class="dt">Activity</span> <span class="ot">-&gt;</span> <span class="dt">Activity</span></a></code></pre></div>
<p>that modify interactions? Then we can obviously compose them. We would also need a type</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb69-1" title="1"><span class="ot">runActivity ::</span> <span class="dt">Activity</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a></code></pre></div>
<p>that actually runs this interaction.</p>
<p>It is possible to define such a type <code>Activity</code>. Can you imagine how?</p>
<p>An interaction is defined by a state type, and by the three parameters that we so far have passed to <code>activityOf</code>. So let us not pass them to <code>activityOf</code>, but rather store them in a datatype:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb70-1" title="1"><span class="kw">data</span> <span class="dt">Activity</span> world <span class="fu">=</span> <span class="dt">Activity</span></a>
<a class="sourceLine" id="cb70-2" title="2">        world</a>
<a class="sourceLine" id="cb70-3" title="3">    (<span class="dt">Event</span> <span class="ot">-&gt;</span> world <span class="ot">-&gt;</span> world)</a>
<a class="sourceLine" id="cb70-4" title="4">    (world <span class="ot">-&gt;</span> <span class="dt">Picture</span>)</a></code></pre></div>
<p>Because of the type variable <code>world</code>, the type signatures of <code>resetable</code> and <code>withStartScreen</code> are a bit more complicated. We can use type inference to let the compiler figure it out for us, though.</p>
<p>Changing the existing functions <code>startScreenActivityOf</code> to <code>withStartScreen</code>, and <code>resetableActivityOf</code> to <code>resetable</code> turns out to be trivial: Just replace the three parameters by one, pattern matching on <code>Activity</code>, and replace the use of <code>activityOf</code> with the constructor <code>Activity</code>:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb71-1" title="1"><span class="ot">resetable ::</span> <span class="dt">Activity</span> s <span class="ot">-&gt;</span> <span class="dt">Activity</span> s</a>
<a class="sourceLine" id="cb71-2" title="2">resetable (<span class="dt">Activity</span> state0 handle draw)</a>
<a class="sourceLine" id="cb71-3" title="3">  <span class="fu">=</span> <span class="dt">Activity</span> state0 handle&#39; draw</a>
<a class="sourceLine" id="cb71-4" title="4">  <span class="kw">where</span> handle&#39; (<span class="dt">KeyPress</span> key) _ <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Esc&quot;</span> <span class="fu">=</span> state0</a>
<a class="sourceLine" id="cb71-5" title="5">        handle&#39; e s <span class="fu">=</span> handle e s</a>
<a class="sourceLine" id="cb71-6" title="6"></a>
<a class="sourceLine" id="cb71-7" title="7"><span class="ot">withStartScreen ::</span> <span class="dt">Activity</span> s <span class="ot">-&gt;</span> <span class="dt">Activity</span> (<span class="dt">SSState</span> s)</a>
<a class="sourceLine" id="cb71-8" title="8">withStartScreen (<span class="dt">Activity</span> state0 handle draw)</a>
<a class="sourceLine" id="cb71-9" title="9">  <span class="fu">=</span> <span class="dt">Activity</span> state0&#39; handle&#39; draw&#39;</a>
<a class="sourceLine" id="cb71-10" title="10">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb71-11" title="11">    state0&#39; <span class="fu">=</span> <span class="dt">StartScreen</span></a>
<a class="sourceLine" id="cb71-12" title="12"></a>
<a class="sourceLine" id="cb71-13" title="13">    handle&#39; (<span class="dt">KeyPress</span> key) <span class="dt">StartScreen</span></a>
<a class="sourceLine" id="cb71-14" title="14">         <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot; &quot;</span>                  <span class="fu">=</span> <span class="dt">Running</span> state0</a>
<a class="sourceLine" id="cb71-15" title="15">    handle&#39; _              <span class="dt">StartScreen</span> <span class="fu">=</span> <span class="dt">StartScreen</span></a>
<a class="sourceLine" id="cb71-16" title="16">    handle&#39; e              (<span class="dt">Running</span> s) <span class="fu">=</span> <span class="dt">Running</span> (handle e s)</a>
<a class="sourceLine" id="cb71-17" title="17"></a>
<a class="sourceLine" id="cb71-18" title="18">    draw&#39; <span class="dt">StartScreen</span> <span class="fu">=</span> startScreen</a>
<a class="sourceLine" id="cb71-19" title="19">    draw&#39; (<span class="dt">Running</span> s) <span class="fu">=</span> draw s</a></code></pre></div>
<p>The function <code>runActivity</code> is also very simply to write: We just pattern match on <code>Activity</code> to get our hands on the individual functions, and pass them to <code>activityOf</code>:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb72-1" title="1"><span class="ot">runActivity ::</span> <span class="dt">Activity</span> s <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb72-2" title="2">runActivity (<span class="dt">Activity</span> state0 handle draw)</a>
<a class="sourceLine" id="cb72-3" title="3">  <span class="fu">=</span> activityOf state0 handle draw</a></code></pre></div>
<p>The final bit we need to change, before we can put everything together, is to actually have an <code>Activity</code> that represents the basic Sokoban game:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb73-1" title="1"><span class="ot">sokoban ::</span> <span class="dt">Activity</span> <span class="dt">State</span></a>
<a class="sourceLine" id="cb73-2" title="2">sokoban <span class="fu">=</span> <span class="dt">Activity</span> initialState handleEvent2 drawState2</a></code></pre></div>
<p>And finally, we can compose our interactions (<a href="https://code.world/haskell#PxcmjVEZsd9L6ExmcvXzffw">open on CodeWorld</a>). Try to start the game with space, and reset it with the escape key again!</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb74-1" title="1">main <span class="fu">=</span> runActivity (resetable (withStartScreen sokoban))</a></code></pre></div>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DMgfMI5BicScryyvaSkkkrw">
</iframe>
<p>Think about what happens if we switch the order of <code>resetable</code> and <code>withStartScreen</code>!</p>
</section>
</section>
<section id="recursive-data-types" class="level1">
<h1><span class="header-section-number">12</span> Recursive data types</h1>
<p>An important concept that you will need in more complex programs (such as a proper Sokoban implementation) is recursive datatypes. These can be used to implement lists and trees and many other data structures.</p>
<p>In our game, the boxes will have to be moved around. It is likely that we will want to manage a list of coordinates of these boxes, and clearly, this is going to be part of our state.</p>
<p>Our code should work with any number of boxes (as various levels have various number of boxes). What type is suitable to store any number of coordinates? Or – as you would expect after we talked about polymorphism – any number of values of some arbitrary type?</p>
<section id="lists" class="level3">
<h3><span class="header-section-number">12.0.1</span> Lists</h3>
<p>Of course, the standard library comes with a suitable data type, but let us, for the sake of learning, define it ourselves. Just like we used recursion in functions to replace loops, we can use recursion in types to implement lists:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb75-1" title="1"><span class="kw">data</span> <span class="dt">List</span> a <span class="fu">=</span> <span class="dt">Empty</span> <span class="fu">|</span> <span class="dt">Entry</span> a (<span class="dt">List</span> a)</a></code></pre></div>
<p>So a value of type <code>List a</code> is either the constructor <code>Empty</code>, or there is a list entry, which is a value of type <code>a</code>, and then the remainder of the list, i.e. another value of type <code>List a</code>.</p>
<p>We can define a value of that type, by using the constructors, as you would expect:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb76-1" title="1"><span class="ot">someBoxCoords ::</span> <span class="dt">List</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb76-2" title="2">someBoxCoords <span class="fu">=</span> <span class="dt">Entry</span> (<span class="dt">C</span> <span class="dv">2</span> <span class="dv">2</span>) (<span class="dt">Entry</span> (<span class="dt">C</span> <span class="dv">3</span> <span class="dv">3</span>) (<span class="dt">Entry</span> (<span class="dt">C</span> (<span class="fu">-</span><span class="dv">1</span>) <span class="dv">0</span>) <span class="dt">Empty</span>))</a></code></pre></div>
<p>Similarly, we can look at the elements of a list by pattern matching:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb77-1" title="1"><span class="ot">firstBox ::</span> <span class="dt">List</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb77-2" title="2">firstBox <span class="dt">Empty</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb77-3" title="3">firstBox (<span class="dt">Entry</span> c _) <span class="fu">=</span> atCoord c (drawTile <span class="dt">Box</span>)</a>
<a class="sourceLine" id="cb77-4" title="4"></a>
<a class="sourceLine" id="cb77-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb77-6" title="6">main <span class="fu">=</span> drawingOf (firstBox someBoxCoords)</a></code></pre></div>
<p>Now, what if we want to draw all boxes in the list? We would also start by pattern-matching on the list, handle the empty case, and handle one entry, and then recurse on the remaining list (<a href="https://code.world/haskell#PY_bmIaZD2lN7Tu5txLlvVw">open on CodeWorld</a>):</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb78-1" title="1"><span class="ot">pictureOfBoxes ::</span> <span class="dt">List</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb78-2" title="2">pictureOfBoxes <span class="dt">Empty</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb78-3" title="3">pictureOfBoxes (<span class="dt">Entry</span> c cs) <span class="fu">=</span> atCoord c (drawTile <span class="dt">Box</span>) <span class="fu">&amp;</span> boxes cs</a>
<a class="sourceLine" id="cb78-4" title="4"></a>
<a class="sourceLine" id="cb78-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb78-6" title="6">main <span class="fu">=</span> drawingOf (pictureOfBoxes someBoxCoords)</a></code></pre></div>
<p>We observe that the recursion on the value level (in the function <code>pictureOfBoxes</code>) corresponds to the recursion on the type level (in the type <code>List</code>). This is a common idiom.</p>
<p>Let us make this interactive again: We want to use the arrow keys to move <em>all</em> boxes. Here is one way of doing that:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb79-1" title="1"><span class="ot">movingBoxes ::</span> <span class="dt">Activity</span> (<span class="dt">List</span> <span class="dt">Coord</span>)</a>
<a class="sourceLine" id="cb79-2" title="2">movingBoxes <span class="fu">=</span> <span class="dt">Activity</span> someBoxCoords handle draw</a>
<a class="sourceLine" id="cb79-3" title="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb79-4" title="4">    draw <span class="fu">=</span> pictureOfBoxes</a>
<a class="sourceLine" id="cb79-5" title="5">    handle (<span class="dt">KeyPress</span> key) s</a>
<a class="sourceLine" id="cb79-6" title="6">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Right&quot;</span> <span class="fu">=</span> moveAllBoxes <span class="dt">R</span> s</a>
<a class="sourceLine" id="cb79-7" title="7">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Up&quot;</span>    <span class="fu">=</span> moveAllBoxes <span class="dt">U</span> s</a>
<a class="sourceLine" id="cb79-8" title="8">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Left&quot;</span>  <span class="fu">=</span> moveAllBoxes <span class="dt">L</span> s</a>
<a class="sourceLine" id="cb79-9" title="9">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Down&quot;</span>  <span class="fu">=</span> moveAllBoxes <span class="dt">D</span> s</a>
<a class="sourceLine" id="cb79-10" title="10">    handle _ s      <span class="fu">=</span> s</a>
<a class="sourceLine" id="cb79-11" title="11"></a>
<a class="sourceLine" id="cb79-12" title="12"><span class="ot">moveAllBoxes ::</span> <span class="dt">Direction</span> <span class="ot">-&gt;</span> <span class="dt">List</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">List</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb79-13" title="13">moveAllBoxes _ <span class="dt">Empty</span> <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb79-14" title="14">moveAllBoxes d (<span class="dt">Entry</span> c cs) <span class="fu">=</span> <span class="dt">Entry</span> (adjacentCoord d c) (moveAllBoxes d cs)</a></code></pre></div>
<p>This works! But we are not satisfied. The function <code>moveAllBoxes</code> does a bit too much for my taste: We there have the logic of <em>both</em> moving a single box <em>and</em> traversing the list. Can we separate them? Sure we can, using higher order functions!</p>
</section>
<section id="maplist" class="level3">
<h3><span class="header-section-number">12.0.2</span> mapList</h3>
<p>We start by writing a very general apply-a-function-to-every-element-in-a-list function:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb80-1" title="1">mapList _ <span class="dt">Empty</span> <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb80-2" title="2">mapList f (<span class="dt">Entry</span> c cs) <span class="fu">=</span> <span class="dt">Entry</span> (f c) (mapList f cs)</a></code></pre></div>
<p>and then we can use it in <code>handle</code> (note how partially applying <code>adjacentCoord</code> works out so nicely here!):</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb81-1" title="1">    handle (<span class="dt">KeyPress</span> key) s</a>
<a class="sourceLine" id="cb81-2" title="2">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Right&quot;</span> <span class="fu">=</span> mapList (adjacentCoord <span class="dt">R</span>) s</a>
<a class="sourceLine" id="cb81-3" title="3">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Up&quot;</span>    <span class="fu">=</span> mapList (adjacentCoord <span class="dt">U</span>) s</a>
<a class="sourceLine" id="cb81-4" title="4">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Left&quot;</span>  <span class="fu">=</span> mapList (adjacentCoord <span class="dt">L</span>) s</a>
<a class="sourceLine" id="cb81-5" title="5">        <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;Down&quot;</span>  <span class="fu">=</span> mapList (adjacentCoord <span class="dt">D</span>) s</a>
<a class="sourceLine" id="cb81-6" title="6">    handle _ s      <span class="fu">=</span> s</a></code></pre></div>
<p>What do you think is the type signature of <code>mapList</code>?</p>
</section>
<section id="combine" class="level3">
<h3><span class="header-section-number">12.0.3</span> combine</h3>
<p>The function <code>mapList</code> is very useful, and you will most likely want to use it in your code. In fact, it is generally recommended to use such general higher-order functions instead of writing out an explicit recursion.</p>
<p>Where can we do a similar refactoring? In the function <code>pictureOfBoxes</code>! This function also perform two things that can be separated into smaller, more generally useful parts: For every entry in the list, it creates a <code>Picture</code>, and then it combines all these. So how about this:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb82-1" title="1"><span class="ot">combine ::</span> <span class="dt">List</span> <span class="dt">Picture</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb82-2" title="2">combine <span class="dt">Empty</span> <span class="fu">=</span> blank</a>
<a class="sourceLine" id="cb82-3" title="3">combine (<span class="dt">Entry</span> p ps) <span class="fu">=</span> p <span class="fu">&amp;</span> combine ps</a>
<a class="sourceLine" id="cb82-4" title="4"></a>
<a class="sourceLine" id="cb82-5" title="5"><span class="ot">pictureOfBoxes ::</span> <span class="dt">List</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a>
<a class="sourceLine" id="cb82-6" title="6">pictureOfBoxes cs <span class="fu">=</span> combine (mapList (\c <span class="ot">-&gt;</span> atCoord c (drawTile <span class="dt">Box</span>)) cs)</a></code></pre></div>
<p>Granted, the code did not get much smaller. But we did gain a generally useful <code>combine</code> function. (<a href="https://code.world/haskell#PzhCiJpCK1kiiqr95tHoCww">Open on CodeWorld</a>)</p>
</section>
</section>
<section id="case-expressions" class="level1">
<h1><span class="header-section-number">13</span> Case expressions</h1>
<p>Finally, a small syntactic gimmick, that you might find useful when doing the homework.</p>
<p>So far, the only place where we can do pattern matching is when we define a function. This is sufficient, but sometimes annoying, as it requires local functions that we might want to do without.</p>
<p>So let us say we want to remove all boxes from the maze. We could write it like this:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb83-1" title="1"><span class="ot">noBoxMaze ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Tile</span></a>
<a class="sourceLine" id="cb83-2" title="2">noBoxMaze c <span class="fu">=</span> noBox (maze c)</a>
<a class="sourceLine" id="cb83-3" title="3"> <span class="kw">where</span></a>
<a class="sourceLine" id="cb83-4" title="4"><span class="ot">   noBox ::</span> <span class="dt">Tile</span> <span class="ot">-&gt;</span> <span class="dt">Tile</span></a>
<a class="sourceLine" id="cb83-5" title="5">   noBox <span class="dt">Box</span> <span class="fu">=</span> <span class="dt">Ground</span></a>
<a class="sourceLine" id="cb83-6" title="6">   noBox t   <span class="fu">=</span> t</a></code></pre></div>
<p>but what we would rather write is</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb84-1" title="1"><span class="ot">noBoxMaze ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Tile</span></a>
<a class="sourceLine" id="cb84-2" title="2">noBoxMaze c <span class="fu">=</span> <span class="kw">case</span> maze c <span class="kw">of</span></a>
<a class="sourceLine" id="cb84-3" title="3">   <span class="dt">Box</span> <span class="ot">-&gt;</span> <span class="dt">Ground</span></a>
<a class="sourceLine" id="cb84-4" title="4">   t   <span class="ot">-&gt;</span> t</a></code></pre></div>
<p>The syntax is the keyword <code>case</code>, followed by the expression that we want to analyze (also called the scrutinee), then keyword <code>of</code>, and then, vertically aligned, any number of alternatives. The alternatives consist of a pattern, just like in a function equation, an arrow, and the expression this should evaluate to in case the pattern matches. Even guards can be used here!</p>
</section>
<section id="exercises-build-sokoban" class="level1 exercises">
<h1><span class="header-section-number">14</span> ✍️ Exercises: Build Sokoban</h1>
<p>The goal of this set of exercises is simply: Implement Sokoban!</p>
<p>In order to guide you through the process, and also to make partial grading possible, we will break it down into smaller steps.</p>
<p>You can <a href="https://code.world/haskell#PVcCNwR5HFbbiNTAph7mD6g">start from this template code</a>. It already includes type signatures for some of the functions described below. Make sure you adjust everything defined to be <code>undefined</code> or marked as <code>FIXME</code>. Use your solutions to previous exercises where appropriate (i.e. your custom maze, tiles and player).</p>
<section id="step-1-the-state" class="level2">
<h2><span class="header-section-number">14.1</span> Step 1: The state</h2>
<p>Define a data type <code>State</code> that capture the state of the game. It needs to store these pieces of information:</p>
<ul>
<li>The current position of the player.</li>
<li>The direction the player is facing.</li>
<li>The current positions of all boxes, as a <code>List</code>.</li>
</ul>
</section>
<section id="step-2-the-initial-state" class="level2">
<h2><span class="header-section-number">14.2</span> Step 2: The initial state</h2>
<p>Define a value <code>initialState :: State</code> for the initial state:</p>
<ul>
<li>Manually define a sensible position for the player (i.e. on some <code>Ground</code> tile).</li>
<li>Use an arbitrary direction.</li>
<li>Find where the boxes are.</li>
</ul>
<p>The latter is a bit tricky: The information is there (in the definition of <code>maze</code>), but not very accessible. Do <strong>not</strong> just write down the list of coordinates by hand! Instead, define a value <code>initialBoxes :: List Coord</code> that is calculated from looking at each coordinate (going from -10 to 10, as usual), and adding that coordinate to the list if there is a box.</p>
<p>There are two ways of doing that. Pick one (but try to understand both):</p>
<ol type="1">
<li><p>Define a function</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb85-1" title="1"><span class="ot">appendList ::</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">List</span> a</a></code></pre></div>
<p>which appends two lists. Then you can implement <code>initialBoxes</code> similar to <code>pictureOfMaze</code>, using <code>appendList</code> instead of <code>(&amp;)</code>.</p>
<p>This is called <em>folding <code>appendList</code> over the set of coordinate</em>.</p></li>
<li><p>Alternatively, in your recursions that traverse the coordinate space, pass a list down as a parameter. Initially, this list is <code>Empty</code>. If the current coordinate is not a <code>Box</code>, you simply pass it on. If the current coordinate is a box, you add an <code>Entry</code> to the list, and pass the extended list on.</p>
<p>The helper function could possibly have type</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb86-1" title="1"><span class="ot">go ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">List</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">List</span> <span class="dt">Coord</span></a></code></pre></div>
<p>Such a parameter is called an <em>accumulating parameter</em>.</p></li>
</ol>
<p>You can test your <code>initialBoxes</code> value using</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb87-1" title="1">main <span class="fu">=</span> drawingOf (pictureOfBoxes initialBoxes)</a></code></pre></div>
</section>
<section id="step-3-many-mazes" class="level2">
<h2><span class="header-section-number">14.3</span> Step 3: Many mazes</h2>
<p>The <code>maze</code> as given has boxes in the initial position. That is no good in the long run. Therefore, you need to define two more mazes:</p>
<ul>
<li><p>Define</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb88-1" title="1"><span class="ot">noBoxMaze ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Maze</span></a></code></pre></div>
<p>which behaves like <code>maze</code> with the exception that where <code>maze</code> would return a <code>Box</code>, this returns <code>Ground</code>.</p>
<p>Use this in <code>pictureOfMaze</code> instead of <code>maze</code>. You can test this using</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb89-1" title="1">main <span class="fu">=</span> drawingOf pictureOfMaze</a></code></pre></div></li>
<li><p>Define</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb90-1" title="1"><span class="ot">mazeWithBoxes ::</span> <span class="dt">List</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> (<span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Maze</span>)</a></code></pre></div>
<p>which behaves like <code>noBoxMaze</code> for every coordinate that is not in the list, but returns <code>Box</code> if queried for a coordinate that is in the given list of coordinates.</p>
<p>It will be useful (also below) to define a function</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb91-1" title="1"><span class="ot">eqCoord ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a></code></pre></div>
<p>that checks if two coordinates are the same.</p>
<p>Note that <code>mazeWithBoxes</code>, partially applied to one argument (the list with the current positions of the boxes), has the same type as <code>maze</code>.</p></li>
</ul>
</section>
<section id="step-4-draw-the-state" class="level2">
<h2><span class="header-section-number">14.4</span> Step 4: Draw the state</h2>
<p>Implement</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb92-1" title="1"><span class="ot">draw ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">Picture</span></a></code></pre></div>
<p>The picture consists of three elements:</p>
<ul>
<li>The player, at the current position (use <code>player</code> and <code>atCoord</code>).</li>
<li>The boxes in their current positions (use <code>pictureOfBoxes</code>).</li>
<li>The <code>pictureOfMaze</code> (which uses <code>noBoxMaze</code> internally).</li>
</ul>
</section>
<section id="step-5-handling-event" class="level2">
<h2><span class="header-section-number">14.5</span> Step 5: Handling event</h2>
<p>Implement</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb93-1" title="1"><span class="ot">handleEvent ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">State</span></a></code></pre></div>
<p>React to the arrow keys only. Such an event can either succeed or fail.</p>
<p>It succeeds if the tile moved to is either <code>Ground</code> or <code>Storage</code> or <code>Box</code>. If it is <code>Box</code>, the next tile in that direction has to be <code>Ground</code> or <code>Storage</code>. It fails otherwise.</p>
<p>If the move succeeds, update the state with the new position of the player, the direction he walked to, and the updated position of the boxes.</p>
<p>Hint (you can do it differently if you want): To update the position of the boxes, define a function</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb94-1" title="1"><span class="ot">moveFromTo ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> (<span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span>)</a></code></pre></div>
<p>that takes a position to move from, a position to move to, and the coordinate to adjust. If the first parameter matches the third, return the second, otherwise the third. You can use this function with <code>mapList</code> to update the whole list of coordinates. This conveniently does the right thing (i.e. nothing) if no box is pushed, and does the right thing with boxes that are not pushed. Do not worry about efficiency here.</p>
<p>If the move fails, update only the direction the player.</p>
</section>
<section id="step-6-putting-it-all-together" class="level2">
<h2><span class="header-section-number">14.6</span> Step 6: Putting it all together</h2>
<p>Define an <code>Interaction</code> based on the functions you defined in the previous steps. Wrap it in <code>resetable</code> and <code>withStartScreen</code>, so that pressing the escape key returns to the start screen.</p>
<p>It should now behave roughly like this:</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DiKJ9rAdfymDR3Ndt3JJCcg">
</iframe>
</section>
<section id="step-7-winning" class="level2">
<h2><span class="header-section-number">14.7</span> Step 7: Winning</h2>
<p>One bit is missing: If the game has been won, you need to say so, and further interaction should stop.</p>
<p>Define a function</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb95-1" title="1"><span class="ot">isWon ::</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a></code></pre></div>
<p>which is <code>True</code> if the game is won. It is won if every box is on a <code>Storage</code> tile. To that end, define two helper functions:</p>
<ul>
<li><div class="sourceCode" id="cb96"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb96-1" title="1"><span class="ot">isOnStorage ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a></code></pre></div>
<p>that returns true if the given coordinate is a <code>Storage</code> field.</p></li>
<li><div class="sourceCode" id="cb97"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb97-1" title="1"><span class="ot">allList ::</span> <span class="dt">List</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a></code></pre></div>
<p>which returns true if all entries in the list are <code>True</code>, and <code>False</code> otherwise. If given an empty list it should also return <code>True</code>.</p></li>
</ul>
<p>You can implement <code>isWon</code> using these two functions and <code>mapList</code>.</p>
<p>Use <code>isWon</code> in two places:</p>
<ul>
<li>In <code>draw</code>, if the game is won, write <code>You won!</code> or something similar across the drawn picture of the game.</li>
<li>In <code>handleEvent</code>, if the game is won, ignore all events (i.e. return the state unaltered)</li>
</ul>
<p>The final game should now behave like this:</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DsI0_d27eHv57bhp0lZNv0A">
</iframe>
<!--  solution: https://code.world/haskell#PTgYAt3TMBGGE2-RHL69ANw -->
</section>
</section>
<section id="type-classes" class="level1">
<h1><span class="header-section-number">15</span> Type classes</h1>
<p>In the last set of exercises, you have developed a working implementation of Sokoban. The resulting code might look like <a href="https://code.world/haskell#PDfdyCUBB_oYNWjrsS8R7JA">this example solution</a>.</p>
<p>While implementing it, some of you might have wished to be able to use the equality operator (<code>(==)</code>) on your own data types, such as <code>Coord</code> or <code>Tile</code>. But you could not and had to work around it using <code>case</code> expressions, helper functions or functions like <code>eqCoord</code>.</p>
<p>But you may have already observed that <code>(==)</code> can be used with multiple types: <code>Integer</code>, <code>Double</code>, <code>Bool</code> (although you should not use it with <code>Double</code>!). And I claimed that <code>Bool</code> is not special. So there must be a way of using <code>(==)</code> with, say, <code>Coord</code>.</p>
<p>Maybe the error message that we see if we try to use it, can shed some light on this:</p>
<pre><code>No instance for (Eq Coord) arising from a use of ‘==’</code></pre>
<p>It seems that we need some kind of instance. Before we talk about instances, though, we have to talk about classes.</p>
<p>You can use the Hoogle search engine to <a href="https://hoogle.haskell.org/?hoogle=%3D%3D">search for <code>==</code></a>, and the first entry will tell you about the type of the <code>(==)</code> operator:</p>
<pre><code>Prelude&gt; :t (==)
(==) :: Eq a =&gt; a -&gt; a -&gt; Bool</code></pre>
<p>On the right of the <code>=&gt;</code> arrow, we have the function type that we know: The operator takes two arguments of some type, and returns a boolean. On the left of the <code>=&gt;</code> arrow, we have a <em>type class constraint</em>. This says that <code>(==)</code> can only be used on types that are members of this type class.</p>
<section id="the-eq-type-class" class="level2">
<h2><span class="header-section-number">15.1</span> The Eq type class</h2>
<p>If you click on that link, you’ll reach the the documentation of <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#t:Eq">the <code>Eq</code> class</a>. Among other things, you’ll learn about the type class head, namely</p>
<pre><code>class Eq a where</code></pre>
<p>and its methods, namely</p>
<pre><code>  (==) :: a -&gt; a -&gt; Bool
  (/=) :: a -&gt; a -&gt; Bool</code></pre>
<p>The documentation obscures this a bit, but if you put the two code snippets above together you get what you would write to define such a class yourself.</p>
<p>Note that methods are given with <em>just</em> their type signature – the implementation will be in the class instances. Also, the type is given without the <code>Eq</code> constraint that you saw in the type signature for <code>(==)</code> earlier; this is added automatically.</p>
<p>The documentation also shows that there are many many <em>instances</em> for this class:</p>
<pre><code>instance Eq Bool
instance Eq Char
instance Eq Double
…
instance Eq a =&gt; Eq [a]
…</code></pre>
</section>
<section id="the-eq-coord-instance" class="level2">
<h2><span class="header-section-number">15.2</span> The <code>Eq Coord</code> instance</h2>
<p>Now that we know what method the class as, we can write our own instance for <code>Coord</code>:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb103-1" title="1"><span class="kw">instance</span> <span class="dt">Eq</span> <span class="dt">Coord</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb103-2" title="2">  <span class="dt">C</span> x1 y1 <span class="fu">==</span> <span class="dt">C</span> x2 y2 <span class="fu">=</span> x1 <span class="fu">==</span> x2 <span class="fu">&amp;&amp;</span> y1 <span class="fu">==</span> y2</a>
<a class="sourceLine" id="cb103-3" title="3">  c1 <span class="fu">/=</span> c2 <span class="fu">=</span> <span class="fu">not</span> (c1 <span class="fu">==</span> c2)</a></code></pre></div>
<p>So after the <code>instance</code> keyword, we name the type class that we want to instantiate and the type for which we want to define an instance. Then, after <code>where</code> and indented, we give function definitions for the methods. We can use multiple patterns, guards, and all that as usual. We do <em>not</em> give a type signature, because the type of these methods is already determined by the class definition and the <em>instance head</em>.</p>
<p>Now our code compiles again.</p>
</section>
<section id="default-implementations" class="level2">
<h2><span class="header-section-number">15.3</span> Default implementations</h2>
<p>Note that I was lazy and did not really implement <code>(/=)</code>; I just referred to the implementation of <code>(==)</code>. Obviously, that is fair game for <em>every</em> instance of <code>Eq</code> that one might want to implement.</p>
<p>Therefore, the <code>Eq</code> class already comes with a <em>default implementation</em> of <code>(/=)</code> in terms of <code>(==)</code> and we can simply skip the definition in our code.</p>
<p>How do we know that we can leave out <code>(/=)</code>? We can try (the compiler will warn us about missing instances), or we can check out <a href="http://hackage.haskell.org/package/base/docs/Prelude.html#t:Eq">the documentation</a> or <a href="http://hackage.haskell.org/package/ghc-prim-0.6.1/docs/src/GHC.Classes.html#Eq">the source</a> (which are a bit harder to find for <code>Eq</code> because it is so basic).</p>
<p>By making a function a method of the class with an default implementation, the authors of an instance have the option of implementing it (for example if a more efficient implementation is possible), but they do not have to.</p>
</section>
<section id="the-eq-tile-instance" class="level2">
<h2><span class="header-section-number">15.4</span> The <code>Eq Tile</code> instance</h2>
<p>So great: We can now use <code>==</code> on <code>Coords</code>. We also want it on <code>Tiles</code>. That is easy to write:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb104-1" title="1"><span class="kw">instance</span> <span class="dt">Eq</span> <span class="dt">Tile</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb104-2" title="2">  <span class="dt">Wall</span> <span class="fu">==</span> <span class="dt">Wall</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb104-3" title="3">  <span class="dt">Ground</span> <span class="fu">==</span> <span class="dt">Ground</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb104-4" title="4">  <span class="dt">Storage</span> <span class="fu">==</span> <span class="dt">Storage</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb104-5" title="5">  <span class="dt">Box</span> <span class="fu">==</span> <span class="dt">Box</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb104-6" title="6">  <span class="dt">Blank</span> <span class="fu">==</span> <span class="dt">Blank</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb104-7" title="7">  _ <span class="fu">==</span> _ <span class="fu">=</span> <span class="dt">False</span></a></code></pre></div>
<p>Now that works, but I am sure you can immediately tell me why this is not satisfying: That is a lot of code to write, it is repetitive, and if we add another constructor to <code>Tile</code>, the code will be wrong.</p>
<p>Luckily, at least for some of the basic type classes, the compiler can write the instance for us. We just have to instruct it to:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb105-1" title="1"><span class="kw">data</span> <span class="dt">Tile</span> <span class="fu">=</span> <span class="dt">Wall</span> <span class="fu">|</span> <span class="dt">Ground</span> <span class="fu">|</span> <span class="dt">Storage</span> <span class="fu">|</span> <span class="dt">Box</span> <span class="fu">|</span> <span class="dt">Blank</span> <span class="kw">deriving</span> <span class="dt">Eq</span></a></code></pre></div>
<p>(If are are playing around with this locally, then pass <code>-ddump-deriv</code> to the compiler to see that it actually creates the same code that we wrote above.)</p>
</section>
<section id="equality-is-not-for-everyone" class="level2">
<h2><span class="header-section-number">15.5</span> Equality is not for everyone</h2>
<p>So great, we get to use <code>(==)</code> on all our types! All our types? Unfortunately not. Last week we defined the type <code>Activity</code>. Some fields of this data type are functions, and equality on functions is, in general, undecidable. If we tried to use <code>deriving Eq</code> on <code>Activity</code>, we would get the error message</p>
<pre><code>No instance for (Eq (world -&gt; Picture))</code></pre>
</section>
<section id="benefits-of-type-classes" class="level2">
<h2><span class="header-section-number">15.6</span> Benefits of type classes</h2>
<p>So great, we get to use <code>(==)</code> on <em>almost</em> all our types! This is also called <em>overloading</em>, and is a nice feature of type classes, but not the only and probably not the most important one. The important features are:</p>
<section id="overloading-of-names" class="level3">
<h3><span class="header-section-number">15.6.1</span> Overloading of names</h3>
<p>As just discussed.</p>
</section>
<section id="laws" class="level3">
<h3><span class="header-section-number">15.6.2</span> Laws!</h3>
<p>When you see <code>(==)</code> and <code>(/=)</code>, you immediately assume that <code>a /= b</code> is <code>True</code> if and only if <code>a == b</code> is <code>False</code>. By convention, every instance of <code>(==)</code> fulfills this law, and the derived instances do as well. For other type classes, the laws are more interesting, but that is a topic for some other time.</p>
<p>Note that such laws are not checked by the compiler (it cannot do that, in general), and nothing is stopping you from implementing a bogus instance. But if you do, do not complain if things break in weird ways.</p>
</section>
<section id="generic-algorithms" class="level3">
<h3><span class="header-section-number">15.6.3</span> Generic algorithms</h3>
<p>Have a look at the definition of <code>moveFromTo</code>:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb107-1" title="1"><span class="ot">moveFromTo ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Coord</span></a>
<a class="sourceLine" id="cb107-2" title="2">moveFromTo c1 c2 c <span class="fu">|</span> c1 <span class="fu">==</span> c   <span class="fu">=</span> c2</a>
<a class="sourceLine" id="cb107-3" title="3">                   <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> c</a></code></pre></div>
<p>There is nothing <code>Coord</code>-specific going on any more! And indeed, if we remove the type signature, and let the compiler propose one to us, we get the suggestion to write</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb108-1" title="1"><span class="ot">moveFromTo ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb108-2" title="2">moveFromTo c1 c2 c <span class="fu">|</span> c1 <span class="fu">==</span> c   <span class="fu">=</span> c2</a>
<a class="sourceLine" id="cb108-3" title="3">                   <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> c</a></code></pre></div>
<p>This means that <code>moveFromTo</code> is a very generally usable function. We only write it once and can use it with many different types.</p>
<p>Now, this function is not very impressive, but we can implement very complex functionality in a generic and reusable way this way, especially when the type class in question comes with laws (see above).</p>
</section>
<section id="instance-resolution" class="level3">
<h3><span class="header-section-number">15.6.4</span> Instance resolution</h3>
<p>When using overloaded functions, the compiler has to find the relevant instance for the type you are using it. With polymorphic types, this instance might require another one (as we will see shortly). With some trickery and/or some language extensions supported by GHC this <em>instance resolution</em> process can be a powerful machinery that not only relieves you from writing some tedious code, but can actually solve some puzzling problems for you. In a way, it is a small logic programming language embedded in the type system.</p>
<p>I will demonstrate this in a moment, but let’s continue with the general remarks first.</p>
</section>
<section id="coherence" class="level3">
<h3><span class="header-section-number">15.6.5</span> Coherence</h3>
<p>Haskell guarantees that for a particular type and a particular type class, there is at most one instance. If we would try to define <code>instance Eq Coord</code> again, the compiler will bark at us.</p>
<p>This means that the meaning of an overloaded function depends only on the concrete type it is used with, but not in what context it is used. This is used by the library implementation of search trees, which uses the <code>Ord</code> instance of the type of keys to build the tree, and this would go horribly wrong if you build the tree with one particular ordering, and then search in it using a completely different ordering.</p>
</section>
</section>
<section id="use-case-undo-stacks" class="level2">
<h2><span class="header-section-number">15.7</span> Use case: Undo stacks</h2>
<p>Let us demonstrate how we can make use of instance resolution, by implementing generic undo functionality. When testing your solution, you surely moved your box onto the wall and wished you did not have to start over again. So let us implement this, in generic way, as a <code>Activity</code>-modifying function:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb109-1" title="1"><span class="kw">data</span> <span class="dt">WithUndo</span> a <span class="fu">=</span> <span class="dt">WithUndo</span> a (<span class="dt">List</span> a)</a>
<a class="sourceLine" id="cb109-2" title="2"></a>
<a class="sourceLine" id="cb109-3" title="3"><span class="ot">withUndo ::</span> <span class="dt">Activity</span> a <span class="ot">-&gt;</span> <span class="dt">Activity</span> (<span class="dt">WithUndo</span> a)</a>
<a class="sourceLine" id="cb109-4" title="4">withUndo (<span class="dt">Activity</span> state0 handle draw)</a>
<a class="sourceLine" id="cb109-5" title="5">  <span class="fu">=</span> <span class="dt">Activity</span> state0&#39; handle&#39; draw&#39;</a>
<a class="sourceLine" id="cb109-6" title="6">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb109-7" title="7">    state0&#39; <span class="fu">=</span> <span class="dt">WithUndo</span> state0 <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb109-8" title="8"></a>
<a class="sourceLine" id="cb109-9" title="9">    handle&#39; (<span class="dt">KeyPress</span> key) (<span class="dt">WithUndo</span> s stack) <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;U&quot;</span></a>
<a class="sourceLine" id="cb109-10" title="10">      <span class="fu">=</span> <span class="kw">case</span> stack <span class="kw">of</span> <span class="dt">Entry</span> s&#39; stack&#39; <span class="ot">-&gt;</span> <span class="dt">WithUndo</span> s&#39; stack&#39;</a>
<a class="sourceLine" id="cb109-11" title="11">                      <span class="dt">Empty</span>           <span class="ot">-&gt;</span> <span class="dt">WithUndo</span> s <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb109-12" title="12">    handle&#39; e              (<span class="dt">WithUndo</span> s stack)</a>
<a class="sourceLine" id="cb109-13" title="13">       <span class="fu">=</span> <span class="dt">WithUndo</span> (handle e s) (<span class="dt">Entry</span> s stack)</a>
<a class="sourceLine" id="cb109-14" title="14"></a>
<a class="sourceLine" id="cb109-15" title="15">    draw&#39; (<span class="dt">WithUndo</span> s _) <span class="fu">=</span> draw s</a></code></pre></div>
<p>This code (<a href="https://code.world/haskell#PNZMlQWvEBzDTLlXod_TOUw">open on CodeWorld</a>) looks good, but if we we use it (by using <code>withUndo</code> in <code>main</code>), it does not seem to work. What went wrong?</p>
<p>The problem is that we push the state to the stack on every event. That includes mouse moves, that includes button releases. What we really would like to do is push a change only on to the stack if the event actually had an effect!</p>
<p>So we need to check that in the <code>handle'</code> function, before we push a new state onto the stack:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb110-1" title="1">    handle&#39; (<span class="dt">KeyPress</span> key) (<span class="dt">WithUndo</span> s stack) <span class="fu">|</span> key <span class="fu">==</span> <span class="st">&quot;U&quot;</span></a>
<a class="sourceLine" id="cb110-2" title="2">      <span class="fu">=</span> <span class="kw">case</span> stack <span class="kw">of</span> <span class="dt">Entry</span> s&#39; stack&#39; <span class="ot">-&gt;</span> <span class="dt">WithUndo</span> s&#39; stack&#39;</a>
<a class="sourceLine" id="cb110-3" title="3">                      <span class="dt">Empty</span>           <span class="ot">-&gt;</span> <span class="dt">WithUndo</span> s <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb110-4" title="4">    handle&#39; e              (<span class="dt">WithUndo</span> s stack)</a>
<a class="sourceLine" id="cb110-5" title="5">       <span class="fu">|</span> s&#39; <span class="fu">==</span> s <span class="fu">=</span> <span class="dt">WithUndo</span> s stack</a>
<a class="sourceLine" id="cb110-6" title="6">       <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> <span class="dt">WithUndo</span> (handle e s) (<span class="dt">Entry</span> s stack)</a>
<a class="sourceLine" id="cb110-7" title="7">      <span class="kw">where</span> s&#39; <span class="fu">=</span> handle e s</a></code></pre></div>
<p>This does not work yet, the compiler complains:</p>
<pre><code>No instance for (Eq a) arising from a use of ‘==’</code></pre>
<p>which makes sense: In order to compare the state of the interaction we are wrapping, the state needs to be comparable! So we have to extend the type signature:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb112-1" title="1"><span class="ot">withUndo ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> <span class="dt">Activity</span> a <span class="ot">-&gt;</span> <span class="dt">Activity</span> (<span class="dt">WithUndo</span> a)</a></code></pre></div>
<p>But the compiler is still not satisfied:</p>
<pre><code>No instance for (Eq State) arising from a use of ‘withUndo’</code></pre>
<p>We have not yet defined an <code>Eq</code> instance for <code>State</code>! But we know how to do that quickly: Using <code>deriving Eq</code>. This will, as one might expect, also ask for <code>Eq</code> instances for <code>Direction</code> and <code>List</code>, which we give the same way.</p>
<p>Yay, that works (<a href="https://code.world/haskell#PFCT3zGFx57BcEOzOS8VQ1A">open on CodeWorld</a>):</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DKL2I_lursxW0lGWMswx8jg">
</iframe>
<p>Now what if we swap the use of <code>withUndo</code> and <code>withStartScreen</code>? We get an error message saying</p>
<pre><code>No instance for (Eq (SSState State))</code></pre>
<p>So we should give an <code>Eq</code> instance for <code>SSState</code>. We could use <code>deriving</code>, but lets do it by hand to learn something.</p>
<p>We have introduced <code>withStartScreen</code>, and hence <code>SSState</code>, to be polymorphic and work with any possible wrapped state. So likewise, we do not want to write an instance just for <code>SSState State</code>, but rather <code>SSState s</code> for any type <code>s</code>. So lets write that:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb115-1" title="1"><span class="kw">instance</span> <span class="dt">Eq</span> (<span class="dt">SSState</span> s) <span class="kw">where</span></a>
<a class="sourceLine" id="cb115-2" title="2">  <span class="dt">StartScreen</span> <span class="fu">==</span> <span class="dt">StartScreen</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb115-3" title="3">  <span class="dt">Running</span> s <span class="fu">==</span> <span class="dt">Running</span> s&#39; <span class="fu">=</span> s <span class="fu">==</span> s&#39;</a>
<a class="sourceLine" id="cb115-4" title="4">  _ <span class="fu">==</span> _ <span class="fu">=</span> <span class="dt">False</span></a></code></pre></div>
<p>This does not work yet, we get an error message:</p>
<pre><code>No instance for (Eq s) arising from a use of ‘==’</code></pre>
<p>This makes sense: If the underlying state type does not support equality, then the extended type cannot do it either. But where do we add the constraint that this <code>Eq</code> instance does only work if <code>s</code> itself is a member of the <code>Eq</code> typeclass? We add this to the instance head:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb117-1" title="1"><span class="kw">instance</span> <span class="dt">Eq</span> s <span class="ot">=&gt;</span> <span class="dt">Eq</span> (<span class="dt">SSState</span> s) <span class="kw">where</span></a>
<a class="sourceLine" id="cb117-2" title="2">  <span class="dt">StartScreen</span> <span class="fu">==</span> <span class="dt">StartScreen</span> <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb117-3" title="3">  <span class="dt">Running</span> s <span class="fu">==</span> <span class="dt">Running</span> s&#39; <span class="fu">=</span> s <span class="fu">==</span> s&#39;</a>
<a class="sourceLine" id="cb117-4" title="4">  _ <span class="fu">==</span> _ <span class="fu">=</span> <span class="dt">False</span></a></code></pre></div>
<p>This works, and now pressing U gets us back to the start screen. (<a href="https://code.world/haskell#P9xGCmiiizJDwzpMLPP0Tgg">Try it on codeworld</a>).</p>
<p>What is happening here? As we compose functions that transform <code>Activity</code>s, the type of the state of these interactions grows. And then, when there is a function like <code>withUndo</code> that has an <code>Eq</code> constraint, the compiler uses the existing instances of <code>Eq</code> to break this complex type down again, and this way constructs, on the spot, a way to equate values of this complex type.</p>
<p>Naturally, this example has been very small, but I hope it gave you an impression at what might be possible.</p>
<!-- this state: https://code.world/haskell#PZ2vR0V_ZaWGU8XKe-54seA -->
<p><strong>Question</strong>: Are there other designs that do not require an explicit equality check to implement undo? Which one would you prefer?</p>
</section>
<section id="type-classes-vs.-object-oriented-classes" class="level2">
<h2><span class="header-section-number">15.8</span> Type classes vs. object-oriented classes</h2>
<p>Many of you might have experience with object-oriented programming languages like Java. You are in danger! Do not fall in the trap of confusing type classes (in Haskell) with classes (in Java)! They are not very similar, and you do not use them to solve the same problems.</p>
<p>If anything, type classes correspond to <em>interfaces</em> in Java: Both contain methods without implementation and their type signatures, and instances provide the implementation.</p>
<p>Classes and objects as in Java do not have a direct correspondence in Haskell, and that is ok, because problems are approached differently. But the <code>Activity</code> type that we defined above week is, in some sense, an approximation of a class. The concrete <code>Activity</code>s that we defined are instances of this class, and functions like <code>withStartScreen</code> relate to inheritance (or maybe to the decorator pattern).</p>
</section>
<section id="other-type-classes-you-should-know-about" class="level2">
<h2><span class="header-section-number">15.9</span> Other type classes you should know about</h2>
<p>Besides <code>Eq</code>, you should know about these type classes:</p>
<ul>
<li><a href="http://hackage.haskell.org/package/base-4.8.2.0/docs/Prelude.html#t:Ord"><code>Ord</code></a>, with methods like <code>(&lt;=)</code>, <code>min</code> and others, for types that can be (totally) ordered. Can be derived.</li>
<li>Many numeric type classes:
<ul>
<li><a href="http://hackage.haskell.org/package/base-4.8.2.0/docs/Prelude.html#t:Num"><code>Num</code></a>, with methods like <code>(+)</code>, <code>(*)</code>, <code>abs</code> and <code>fromInteger</code>, for basic numeric types. Speaking mathematically, this type class captures the operations of a <em>ring</em>. Instances for <code>Int</code>, <code>Integer</code>, <code>Double</code> and others.</li>
<li><a href="http://hackage.haskell.org/package/base-4.8.2.0/docs/Prelude.html#t:Integral"><code>Integral</code></a> with methods like <code>div</code> and <code>mod</code>, for integral types that allow these operations. Instances for <code>Int</code>, <code>Integer</code>, and others.</li>
<li><a href="http://hackage.haskell.org/package/base-4.8.2.0/docs/Prelude.html#t:Fractional"><code>Fractional</code></a> with method <code>(/)</code> for anything that can properly be divided. In particular, <code>Double</code>.</li>
<li><a href="http://hackage.haskell.org/package/base-4.8.2.0/docs/Prelude.html#t:Floating"><code>Floating</code></a> with methods like <code>pi</code>, <code>exp</code>, <code>sin</code>, <code>(**)</code> which require floating point numbers. Instance for <code>Double</code>.</li>
<li><a href="http://hackage.haskell.org/package/base-4.8.2.0/docs/Prelude.html#t:RealFrac"><code>RealFrac</code></a> with methods like <code>round</code>, <code>truncate</code> etc. that convert from floating point numbers to integral numbers.</li>
</ul></li>
</ul>
</section>
</section>
<section id="exercises-graph-algorithms" class="level1 exercises">
<h1><span class="header-section-number">16</span> ✍️ Exercises: Graph algorithms</h1>
<section id="import-the-list-of-mazes" class="level2">
<h2><span class="header-section-number">16.1</span> Import the list of mazes</h2>
<p>The students of the CIS194 course have contributed mazes, and you can <a href="./static/Mazes.hs">download the code of the mazes</a>. It contains a list of mazes (<code>mazes</code>) and a longer list including broken mazes (<code>extraMazes</code>). Paste them into your file, at the very end.</p>
<p>Because the starting position is relevant, we added a data type to go along with the maze:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb118-1" title="1"><span class="kw">data</span> <span class="dt">Maze</span> <span class="fu">=</span> <span class="dt">Maze</span> <span class="dt">Coord</span> (<span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Tile</span>)</a>
<a class="sourceLine" id="cb118-2" title="2"><span class="ot">mazes ::</span> <span class="dt">List</span> <span class="dt">Maze</span></a>
<a class="sourceLine" id="cb118-3" title="3">mazes <span class="fu">=</span> …</a>
<a class="sourceLine" id="cb118-4" title="4"><span class="ot">extraMazes ::</span> <span class="dt">List</span> <span class="dt">Maze</span></a>
<a class="sourceLine" id="cb118-5" title="5">extraMazes <span class="fu">=</span> …</a></code></pre></div>
</section>
<section id="more-polymorphic-list-function" class="level2">
<h2><span class="header-section-number">16.2</span> More polymorphic list function</h2>
<p>Implement these generally useful functions:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb119-1" title="1"><span class="ot">elemList ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb119-2" title="2"><span class="ot">appendList ::</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">List</span> a</a>
<a class="sourceLine" id="cb119-3" title="3"><span class="ot">listLength ::</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">Integer</span></a>
<a class="sourceLine" id="cb119-4" title="4"><span class="ot">filterList ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">List</span> a</a>
<a class="sourceLine" id="cb119-5" title="5"><span class="ot">nth ::</span> <span class="dt">List</span> a <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>These should do what their names and types imply:</p>
<ul>
<li><code>elemList x xs</code> is <code>True</code> if and only if at least one entry in <code>xs</code> equals to <code>x</code>.</li>
<li><code>appendList xs ys</code> should be the list containing the entries of <code>xs</code> followed by those of <code>ys</code>, in that order.</li>
<li><code>listLength xs</code> should be the number of entries in <code>xs</code>.</li>
<li><code>filterList p xs</code> should be the list containing those entries <code>x</code> of <code>xs</code> for which <code>p x</code> is true.</li>
<li><code>nths xs n</code> extracts the <span class="math inline"><em>n</em></span>th entry of the list (start counting with 1). If <span class="math inline"><em>n</em></span> is too large, you may abort the program (by writing <code>error "list too short"</code>, which is an expression that can be used at any type). This is not good style, but shall do for now.</li>
</ul>
</section>
<section id="graph-search" class="level2">
<h2><span class="header-section-number">16.3</span> Graph search</h2>
<p>(Read the next exercise (closedness of mazes) first, to understand why this is an interesting function.)</p>
<p>The algorithm you have to implement below can be phrased very generally, and we want it to be general. So implement a function</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb120-1" title="1"><span class="ot">isGraphClosed ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">List</span> a) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Bool</span></a></code></pre></div>
<p>so that in a call <code>isGraphClosed initial adjacent isOk</code>, where the parameters are</p>
<ul>
<li><code>initial</code>, an initial node,</li>
<li><code>adjacent</code>, a function that for every node lists all walkable adjacent nodes and</li>
<li><code>isOk</code>, which checks if the node is ok to have in the graph,</li>
</ul>
<p>the function returns <code>True</code> if all reachable nodes are “ok” and <code>False</code> otherwise.</p>
<p>Note that the graph described by <code>adjacent</code> can have circles, and you do not want your program to keep running in circles. So you will have to remember what nodes you have already visited.</p>
<p>The algorithm follows quite naturally from handling the various cases in a local helper function <code>go</code> that takes two arguments, namely a list of seen nodes and a list of nodes that need to be handled. If the latter list is empty, you are done. If it is not empty, look at the first entry. Ignore it if you have seen it before. Otherwise, if it is not ok, you are also done. Otherwise, add its adjacent elements to the list of nodes to look at.</p>
</section>
<section id="check-closedness-of-mazes" class="level2">
<h2><span class="header-section-number">16.4</span> Check closedness of mazes</h2>
<p>Write a function</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb121-1" title="1"><span class="ot">isClosed ::</span> <span class="dt">Maze</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a></code></pre></div>
<p>that checks whether the maze is closed. A maze is closed if</p>
<ul>
<li>the starting position is either <code>Ground</code> or <code>Storage</code> and</li>
<li>every reachable tile is either <code>Ground</code>, <code>Storage</code> or <code>Box</code>.</li>
</ul>
<p>Use <code>isGraphClosed</code> to do the second check. Implement <code>adjacent</code> so that <code>isGraphClosed</code> walks everywhere where there is not a <code>Wall</code> (including <code>Blank</code>). Implement <code>isOk</code> so that <code>Blank</code> tiles are not ok.</p>
<p>You might find it helpful to define a list <code>allDirections :: List Direction</code> and use <code>mapList</code> and <code>filterList</code> when implementing <code>adjacent</code>.</p>
<!--
With the following function you can visualize a list of booleans:

```haskell
pictureOfBools :: List Bool -> Picture
pictureOfBools xs = translated (-fromIntegral k /2) (fromIntegral k) (go 0 xs)
  where n = listLength xs
        k = findK 0 - - k is the integer square of n
        findK i | i * i >= n = i
                | otherwise  = findK (i+1)
        go _ Empty = blank
        go i (Entry b bs) =
          translated (fromIntegral (i `mod` k))
                     (-fromIntegral (i `div` k))
                     (pictureOfBool b)
          & go (i+1) bs

        pictureOfBool True =  colored green (solidCircle 0.4)
        pictureOfBool False = colored red   (solidCircle 0.4)
```

Let `exercise3 :: IO ()` be the visualization of `isClosed` applied to every element of `extraMazes`. Obviously, `mapList` wants to be used here.

<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&dhash=DcmaPotzuWThcbL2VAHBRMw"></iframe>
-->
</section>
<section id="multi-level-sokoban" class="level2">
<h2><span class="header-section-number">16.5</span> Multi-Level Sokoban</h2>
<p>Extend your game from the last exercise (or start with <a href="https://code.world/haskell#PDfdyCUBB_oYNWjrsS8R7JA">the example solution</a> to implement multi-level sokoban.</p>
<ul>
<li>Extend the <code>State</code> with a field of type <code>Integer</code>, to indicate the current level (start counting at 1).</li>
<li>The initial state should start with level 1. The initial coordinate is obtained from the entry in <code>mazes</code>.</li>
<li><p>Your <code>handle</code> and <code>draw</code> functions will now need to take an additional argument, the current maze, of type <code>Coord -&gt; Tile</code>, instead of referring to a top-level <code>maze</code> function. Any helper functions (e.g. <code>noBoxMaze</code>) will also have to take this as an argument. This requires many, but straight-forward changes to the code: You can mostly, without much thinking:</p>
<ul>
<li>Check the compiler errors for an affected function, say <code>foo</code>.</li>
<li>Add <code>(Coord -&gt; Tile) -&gt;</code> to the front of <code>foo</code>’s type signature, .</li>
<li>Add a new first parameter <code>maze</code> to <code>foo</code></li>
<li>Everywhere where <code>foo</code> is called, add <code>maze</code> as an argument.</li>
<li>Repeat.</li>
</ul>
<p>To get the current maze, use <code>nth</code> from exercise 1. Of course, make sure you never use <code>nth</code> with a too-short list. A variant <code>nthMaze :: Integer -&gt; (Coord -&gt; Tile)</code> that gets the maze component of the corresponding entry in <code>mazes</code> will also be handy whenever you have the <code>State</code>, but need a <code>maze :: Coord -&gt; Tile</code>.</p></li>
<li><p>If the level is solved and the current level is not the last (use <code>listLength</code> from above) the space bar should load the next level.</p>
There is some code to be shared with the calculation of the initial state! Maybe the same function <code>loadLevel :: Integer -&gt; State</code> can be used in both situations.</li>
<li><p>If the level is solved and the current level is the last, show a different message (e.g. “All done” instead of “You won”).</p></li>
</ul>
<p>Congratulations, you have now created a fully functional multi-level Sokoban game, which should look like this (and you can <a href="https://code.world/haskell#PwZ3Bt7dXUVMbyt2mxxN48g">look at the code here</a>):</p>
<iframe width="400" height="400" src="https://code.world/run.html?mode=haskell&amp;dhash=DfYs9GZ_c0_IRWActoXMqPw">
</iframe>
</section>
</section>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>I know that traffic lights in the US do not have this phase, but it is the correct sequence for most of Germany, and it works better for the homework.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Using numbers here is not good style, and we will fix that next week.<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</section>
</body>
</html>
